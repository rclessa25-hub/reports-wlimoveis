name: üì• Extrair C√≥digo Fonte (Ver3)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        echo "üì• Clonando projeto..."
        git clone --depth=1 https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
        echo "‚úÖ Projeto clonado"
    
    - name: üìù Gerar relat√≥rio
      run: |
        echo "üìÑ Gerando relat√≥rio completo..."
        
        # Data atual
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Encontrar e contar arquivos
        echo "üîç Buscando arquivos..."
        
        # Usar arrays para armazenar arquivos
        html_files=()
        js_files=()
        css_files=()
        json_files=()
        
        while IFS= read -r file; do
          html_files+=("$file")
        done < <(find fonte-completo -name "*.html" -type f 2>/dev/null || true)
        
        while IFS= read -r file; do
          js_files+=("$file")
        done < <(find fonte-completo -name "*.js" -type f 2>/dev/null || true)
        
        while IFS= read -r file; do
          css_files+=("$file")
        done < <(find fonte-completo -name "*.css" -type f 2>/dev/null || true)
        
        while IFS= read -r file; do
          json_files+=("$file")
        done < <(find fonte-completo -name "*.json" -type f 2>/dev/null || true)
        
        # Contagens
        HTML_COUNT=${#html_files[@]}
        JS_COUNT=${#js_files[@]}
        CSS_COUNT=${#css_files[@]}
        JSON_COUNT=${#json_files[@]}
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        # Contar linhas totais
        TOTAL_LINES=0
        
        for file in "${html_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        for file in "${js_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        for file in "${css_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        for file in "${json_files[@]}"; do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        echo "üìä Estat√≠sticas:"
        echo "Total arquivos: $TOTAL_FILES"
        echo "Total linhas: $TOTAL_LINES"
        echo "HTML: $HTML_COUNT"
        echo "JavaScript: $JS_COUNT"
        echo "CSS: $CSS_COUNT"
        echo "JSON: $JSON_COUNT"
        
        # Criar HTML b√°sico
        echo "Criando HTML..."
        
        cat > index.html << 'EOF'
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>C√≥digo Fonte COMPLETO - Im√≥veis Macei√≥</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; }
        header { background: #2c3e50; color: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; }
        h1 { margin: 0; }
        .stats { background: white; padding: 20px; border-radius: 5px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; }
        .file-item { background: white; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .code-viewer { background: #1e1e1e; color: #d4d4d4; padding: 15px; border-radius: 5px; overflow-x: auto; font-family: monospace; margin-top: 20px; }
        pre { margin: 0; }
        .line-number { color: #6a9955; margin-right: 15px; }
        a { color: #3498db; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üì• C√≥digo Fonte COMPLETO</h1>
            <p>Im√≥veis Macei√≥ - Extra√ß√£o completa de todas as linhas</p>
            <p>Gerado em: 
EOF
        
        echo "$DATE_NOW</p>" >> index.html
        echo '</header>' >> index.html
        
        echo '<div class="stats">' >> index.html
        echo "<h2>üìä Estat√≠sticas</h2>" >> index.html
        echo "<p><strong>Total de linhas:</strong> $TOTAL_LINES</p>" >> index.html
        echo "<p><strong>Total de arquivos:</strong> $TOTAL_FILES</p>" >> index.html
        echo "<p><strong>HTML:</strong> $HTML_COUNT arquivos</p>" >> index.html
        echo "<p><strong>JavaScript:</strong> $JS_COUNT arquivos</p>" >> index.html
        echo "<p><strong>CSS:</strong> $CSS_COUNT arquivos</p>" >> index.html
        echo "<p><strong>JSON:</strong> $JSON_COUNT arquivos</p>" >> index.html
        echo '</div>' >> index.html
        
        echo '<h2>üìÅ Lista de Arquivos</h2>' >> index.html
        echo '<div class="file-list">' >> index.html
        
        # Adicionar arquivos HTML
        for file in "${html_files[@]}"; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            
            echo '<div class="file-item">' >> index.html
            echo "<h3>üåê $filename</h3>" >> index.html
            echo "<p>Caminho: $relative_path</p>" >> index.html
            echo "<p>Linhas: $lines</p>" >> index.html
            echo "<p><a href=\"#html_$file_id\">Ver c√≥digo completo</a></p>" >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # Adicionar arquivos JS
        for file in "${js_files[@]}"; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            
            echo '<div class="file-item">' >> index.html
            echo "<h3>üìú $filename</h3>" >> index.html
            echo "<p>Caminho: $relative_path</p>" >> index.html
            echo "<p>Linhas: $lines</p>" >> index.html
            echo "<p><a href=\"#js_$file_id\">Ver c√≥digo completo</a></p>" >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # Adicionar arquivos CSS
        for file in "${css_files[@]}"; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            
            echo '<div class="file-item">' >> index.html
            echo "<h3>üé® $filename</h3>" >> index.html
            echo "<p>Caminho: $relative_path</p>" >> index.html
            echo "<p>Linhas: $lines</p>" >> index.html
            echo "<p><a href=\"#css_$file_id\">Ver c√≥digo completo</a></p>" >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        echo '<h2>üìú C√≥digo Fonte Completo</h2>' >> index.html
        
        # Mostrar c√≥digo de todos os arquivos
        all_files=("${html_files[@]}" "${js_files[@]}" "${css_files[@]}" "${json_files[@]}")
        
        for file in "${all_files[@]}"; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            extension="${filename##*.}"
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            
            case $extension in
              "html") class="html";;
              "js") class="js";;
              "css") class="css";;
              *) class="";;
            esac
            
            echo "<div class=\"code-viewer\" id=\"${class}_${file_id}\">" >> index.html
            echo "<h3>$relative_path ($lines linhas)</h3>" >> index.html
            echo '<pre>' >> index.html
            
            line_num=1
            while IFS= read -r line || [ -n "$line" ]; do
              line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
              echo "<span class=\"line-number\">$line_num</span>$line_escaped<br/>" >> index.html
              line_num=$((line_num + 1))
            done < "$file"
            
            echo '</pre>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '<footer style="margin-top: 40px; padding: 20px; background: #2c3e50; color: white; border-radius: 5px; text-align: center;">' >> index.html
        echo "<p>‚úÖ Extra√ß√£o completa de $TOTAL_LINES linhas em $TOTAL_FILES arquivos</p>" >> index.html
        echo "<p>Gerado em $DATE_NOW</p>" >> index.html
        echo '<p><a href="https://rclessa25-hub.github.io/imoveis-maceio/" style="color: #3498db;">Visitar site principal</a></p>' >> index.html
        echo '</footer>' >> index.html
        
        echo '</div>' >> index.html
        echo '<script>' >> index.html
        echo 'document.querySelectorAll(\'a[href^="#"]\').forEach(anchor => {' >> index.html
        echo '    anchor.addEventListener("click", function(e) {' >> index.html
        echo '        e.preventDefault();' >> index.html
        echo '        const target = document.querySelector(this.getAttribute("href"));' >> index.html
        echo '        if (target) {' >> index.html
        echo '            window.scrollTo({ top: target.offsetTop - 20, behavior: "smooth" });' >> index.html
        echo '        }' >> index.html
        echo '    });' >> index.html
        echo '});' >> index.html
        echo '</script>' >> index.html
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ Relat√≥rio criado com sucesso!"
        echo "Total de linhas extra√≠das: $TOTAL_LINES"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO GERADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "‚úÖ Extra√ß√£o completa realizada"
        echo "‚úÖ Todas as linhas extra√≠das"
        echo "‚úÖ Sem limita√ß√µes de visualiza√ß√£o"
        echo ""
        echo "üåê Acesse em:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üìä Estat√≠sticas:"
        echo "‚Ä¢ Total de linhas: $TOTAL_LINES"
        echo "‚Ä¢ Total de arquivos: $TOTAL_FILES"
        echo "‚Ä¢ Extra√ß√£o completa e sem limita√ß√µes"
