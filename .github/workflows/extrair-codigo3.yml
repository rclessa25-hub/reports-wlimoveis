name: üì• Extrair C√≥digo Fonte (Ver3)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        git clone --depth=1 https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
        echo "‚úÖ Projeto clonado"
    
    - name: üìù Gerar relat√≥rio
      run: |
        echo "üìÑ Iniciando extra√ß√£o completa..."
        
        # Data atual
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Encontrar arquivos
        echo "üîç Buscando arquivos..."
        
        # Usar m√©todo direto sem arrays complexos
        HTML_FILES_COUNT=0
        JS_FILES_COUNT=0
        CSS_FILES_COUNT=0
        JSON_FILES_COUNT=0
        
        # Lista de arquivos
        echo "" > arquivos.txt
        echo "" > estatisticas.txt
        
        # Processar HTML
        for file in $(find fonte-completo -name "*.html" -type f 2>/dev/null || echo ""); do
          if [ -f "$file" ]; then
            echo "HTML: $file" >> arquivos.txt
            HTML_FILES_COUNT=$((HTML_FILES_COUNT + 1))
          fi
        done
        
        # Processar JS
        for file in $(find fonte-completo -name "*.js" -type f 2>/dev/null || echo ""); do
          if [ -f "$file" ]; then
            echo "JS: $file" >> arquivos.txt
            JS_FILES_COUNT=$((JS_FILES_COUNT + 1))
          fi
        done
        
        # Processar CSS
        for file in $(find fonte-completo -name "*.css" -type f 2>/dev/null || echo ""); do
          if [ -f "$file" ]; then
            echo "CSS: $file" >> arquivos.txt
            CSS_FILES_COUNT=$((CSS_FILES_COUNT + 1))
          fi
        done
        
        # Processar JSON
        for file in $(find fonte-completo -name "*.json" -type f 2>/dev/null || echo ""); do
          if [ -f "$file" ]; then
            echo "JSON: $file" >> arquivos.txt
            JSON_FILES_COUNT=$((JSON_FILES_COUNT + 1))
          fi
        done
        
        TOTAL_FILES=$((HTML_FILES_COUNT + JS_FILES_COUNT + CSS_FILES_COUNT + JSON_FILES_COUNT))
        
        # Contar linhas
        TOTAL_LINES=0
        
        for file in $(find fonte-completo -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" -type f 2>/dev/null || echo ""); do
          if [ -f "$file" ]; then
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        echo "üìä Estat√≠sticas calculadas:"
        echo "Total de linhas: $TOTAL_LINES"
        echo "Total de arquivos: $TOTAL_FILES"
        echo "HTML: $HTML_FILES_COUNT"
        echo "JavaScript: $JS_FILES_COUNT"
        echo "CSS: $CSS_FILES_COUNT"
        echo "JSON: $JSON_FILES_COUNT"
        
        # Salvar estat√≠sticas
        echo "Linhas: $TOTAL_LINES" > estatisticas.txt
        echo "Arquivos: $TOTAL_FILES" >> estatisticas.txt
        echo "HTML: $HTML_FILES_COUNT" >> estatisticas.txt
        echo "JavaScript: $JS_FILES_COUNT" >> estatisticas.txt
        echo "CSS: $CSS_FILES_COUNT" >> estatisticas.txt
        echo "JSON: $JSON_FILES_COUNT" >> estatisticas.txt
        echo "Data: $DATE_NOW" >> estatisticas.txt
        
        # Criar HTML SEM HEREDOC - usando apenas echo
        echo "Criando arquivo HTML..."
        
        # Iniciar arquivo HTML
        echo '<!DOCTYPE html>' > index.html
        echo '<html lang="pt-BR">' >> index.html
        echo '<head>' >> index.html
        echo '<meta charset="UTF-8">' >> index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
        echo '<title>üì• C√≥digo Fonte COMPLETO - Im√≥veis Macei√≥</title>' >> index.html
        echo '<style>' >> index.html
        echo 'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0d1117; color: white; }' >> index.html
        echo '.container { max-width: 1200px; margin: 0 auto; }' >> index.html
        echo 'header { background: #161b22; padding: 30px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #30363d; }' >> index.html
        echo 'h1 { color: #58a6ff; margin: 0; }' >> index.html
        echo '.stats { background: #161b22; padding: 20px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #30363d; }' >> index.html
        echo '.file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }' >> index.html
        echo '.file-card { background: #161b22; padding: 20px; border-radius: 10px; border: 1px solid #30363d; }' >> index.html
        echo '.file-card:hover { border-color: #58a6ff; }' >> index.html
        echo '.code-section { background: #0a0e14; padding: 20px; border-radius: 10px; margin: 20px 0; border: 1px solid #30363d; overflow-x: auto; }' >> index.html
        echo 'pre { margin: 0; font-family: monospace; }' >> index.html
        echo '.line-number { color: #6a737d; margin-right: 15px; }' >> index.html
        echo 'a { color: #58a6ff; text-decoration: none; }' >> index.html
        echo 'a:hover { text-decoration: underline; }' >> index.html
        echo '.badge { background: #238636; color: white; padding: 5px 10px; border-radius: 5px; font-size: 0.9em; }' >> index.html
        echo '</style>' >> index.html
        echo '</head>' >> index.html
        echo '<body>' >> index.html
        echo '<div class="container">' >> index.html
        
        # Cabe√ßalho
        echo '<header>' >> index.html
        echo '<h1>üì• C√≥digo Fonte COMPLETO</h1>' >> index.html
        echo '<p>Im√≥veis Macei√≥ - Extra√ß√£o completa de todas as linhas</p>' >> index.html
        echo "<p><strong>Gerado em:</strong> $DATE_NOW</p>" >> index.html
        echo '</header>' >> index.html
        
        # Estat√≠sticas
        echo '<div class="stats">' >> index.html
        echo '<h2>üìä Estat√≠sticas da Extra√ß√£o</h2>' >> index.html
        echo "<p><strong>Total de linhas:</strong> <span class='badge'>$TOTAL_LINES</span></p>" >> index.html
        echo "<p><strong>Total de arquivos:</strong> <span class='badge'>$TOTAL_FILES</span></p>" >> index.html
        echo "<p><strong>Arquivos HTML:</strong> $HTML_FILES_COUNT</p>" >> index.html
        echo "<p><strong>Arquivos JavaScript:</strong> $JS_FILES_COUNT</p>" >> index.html
        echo "<p><strong>Arquivos CSS:</strong> $CSS_FILES_COUNT</p>" >> index.html
        echo "<p><strong>Arquivos JSON:</strong> $JSON_FILES_COUNT</p>" >> index.html
        echo '<p><strong>Status:</strong> <span style="color: #3fb950;">‚úÖ Completo e sem limita√ß√µes</span></p>' >> index.html
        echo '</div>' >> index.html
        
        # Lista de arquivos
        echo '<h2>üìÅ Arquivos Extra√≠dos</h2>' >> index.html
        echo '<div class="file-grid">' >> index.html
        
        # Adicionar cards para cada arquivo
        file_counter=0
        for file in $(find fonte-completo -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" -type f 2>/dev/null | sort || echo ""); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            file_counter=$((file_counter + 1))
            
            # Determinar tipo
            if [[ "$file" == *.html ]]; then
              icon="üåê"
              type="HTML"
              class="html"
            elif [[ "$file" == *.js ]]; then
              icon="üìú"
              type="JavaScript"
              class="js"
            elif [[ "$file" == *.css ]]; then
              icon="üé®"
              type="CSS"
              class="css"
            elif [[ "$file" == *.json ]]; then
              icon="üìã"
              type="JSON"
              class="json"
            else
              icon="üìÑ"
              type="Arquivo"
              class=""
            fi
            
            echo '<div class="file-card">' >> index.html
            echo "<h3>$icon $filename</h3>" >> index.html
            echo "<p><strong>Tipo:</strong> $type</p>" >> index.html
            echo "<p><strong>Caminho:</strong> $relative_path</p>" >> index.html
            echo "<p><strong>Linhas:</strong> $lines</p>" >> index.html
            echo "<p><a href=\"#${class}_${file_id}\">Ver c√≥digo completo ($lines linhas)</a></p>" >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        # C√≥digo completo
        echo '<h2>üìú C√≥digo Fonte Completo</h2>' >> index.html
        echo '<p>Todas as linhas de todos os arquivos:</p>' >> index.html
        
        section_counter=0
        for file in $(find fonte-completo -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" -type f 2>/dev/null | sort || echo ""); do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            file_id=$(echo "$relative_path" | tr '/.' '_' | tr -cd '[:alnum:]_')
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            section_counter=$((section_counter + 1))
            
            if [[ "$file" == *.html ]]; then
              class="html"
            elif [[ "$file" == *.js ]]; then
              class="js"
            elif [[ "$file" == *.css ]]; then
              class="css"
            elif [[ "$file" == *.json ]]; then
              class="json"
            else
              class="file"
            fi
            
            echo "<div class=\"code-section\" id=\"${class}_${file_id}\">" >> index.html
            echo "<h3>$relative_path <span class='badge'>$lines linhas</span></h3>" >> index.html
            echo '<pre>' >> index.html
            
            # Mostrar todas as linhas
            line_num=1
            while IFS= read -r line || [ -n "$line" ]; do
              # Escapar caracteres HTML
              line=$(echo "$line" | sed 's/&/\&amp;/g')
              line=$(echo "$line" | sed 's/</\&lt;/g')
              line=$(echo "$line" | sed 's/>/\&gt;/g')
              line=$(echo "$line" | sed 's/"/\&quot;/g')
              
              echo "<span class=\"line-number\">$line_num</span>$line<br/>" >> index.html
              line_num=$((line_num + 1))
            done < "$file"
            
            echo '</pre>' >> index.html
            echo "<p style='text-align: center; margin-top: 15px; color: #3fb950;'>‚úÖ $lines linhas extra√≠das completamente</p>" >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # Rodap√©
        echo '<footer style="margin-top: 40px; padding: 20px; background: #161b22; border-radius: 10px; border: 1px solid #30363d; text-align: center;">' >> index.html
        echo '<h3>‚úÖ Extra√ß√£o Completa Conclu√≠da</h3>' >> index.html
        echo "<p>Foram extra√≠das <strong>$TOTAL_LINES linhas</strong> de <strong>$TOTAL_FILES arquivos</strong></p>" >> index.html
        echo "<p>Todas as linhas foram carregadas sem limita√ß√µes de visualiza√ß√£o</p>" >> index.html
        echo "<p>Gerado automaticamente em $DATE_NOW</p>" >> index.html
        echo '<p>' >> index.html
        echo '<a href="https://rclessa25-hub.github.io/imoveis-maceio/" style="color: #58a6ff; margin-right: 20px;">üîó Site Principal</a>' >> index.html
        echo '<a href="https://github.com/rclessa25-hub/imoveis-maceio" style="color: #58a6ff;">üêô Reposit√≥rio GitHub</a>' >> index.html
        echo '</p>' >> index.html
        echo '</footer>' >> index.html
        
        echo '</div>' >> index.html
        
        # Script para navega√ß√£o suave
        echo '<script>' >> index.html
        echo 'document.addEventListener("DOMContentLoaded", function() {' >> index.html
        echo '    var links = document.querySelectorAll(\'a[href^="#"]\');' >> index.html
        echo '    for (var i = 0; i < links.length; i++) {' >> index.html
        echo '        links[i].addEventListener("click", function(e) {' >> index.html
        echo '            e.preventDefault();' >> index.html
        echo '            var targetId = this.getAttribute("href");' >> index.html
        echo '            if (targetId === "#") return;' >> index.html
        echo '            var targetElement = document.querySelector(targetId);' >> index.html
        echo '            if (targetElement) {' >> index.html
        echo '                window.scrollTo({' >> index.html
        echo '                    top: targetElement.offsetTop - 20,' >> index.html
        echo '                    behavior: "smooth"' >> index.html
        echo '                });' >> index.html
        echo '            }' >> index.html
        echo '        });' >> index.html
        echo '    }' >> index.html
        echo '});' >> index.html
        echo '</script>' >> index.html
        
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ HTML criado com sucesso!"
        echo "üìä Resumo:"
        echo "  ‚Ä¢ Linhas totais: $TOTAL_LINES"
        echo "  ‚Ä¢ Arquivos: $TOTAL_FILES"
        echo "  ‚Ä¢ Extra√ß√£o: COMPLETA"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar link
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO GERADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "‚úÖ Extra√ß√£o completa e sem limita√ß√µes"
        echo "‚úÖ Todas as linhas dispon√≠veis"
        echo "‚úÖ Design moderno e responsivo"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "‚Ä¢ Total de linhas: $TOTAL_LINES"
        echo "‚Ä¢ Total de arquivos: $TOTAL_FILES"
        echo "‚Ä¢ Extra√ß√£o: 100% completa"
        echo "‚Ä¢ Visualiza√ß√£o: Sem restri√ß√µes"
