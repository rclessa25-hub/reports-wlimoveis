name: üì• Extrair C√≥digo Fonte (Ver3)

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
    
    - name: üìù Gerar relat√≥rio HTML
      run: |
        # Data atual
        DATE=$(date '+%d/%m/%Y %H:%M:%S')
        
        # Iniciar arquivo HTML
        echo '<!DOCTYPE html>' > index.html
        echo '<html lang="pt-BR">' >> index.html
        echo '<head>' >> index.html
        echo '<meta charset="UTF-8">' >> index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
        echo '<title>C√≥digo Fonte Completo - Im√≥veis Macei√≥</title>' >> index.html
        echo '<style>' >> index.html
        echo 'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0d1117; color: white; }' >> index.html
        echo '.container { max-width: 1200px; margin: 0 auto; }' >> index.html
        echo 'header { background: #161b22; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363d; }' >> index.html
        echo '.stats { background: #161b22; padding: 20px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #30363d; }' >> index.html
        echo '.file-section { background: #0a0e14; padding: 20px; border-radius: 8px; margin: 20px 0; border: 1px solid #30363d; }' >> index.html
        echo 'pre { margin: 0; font-family: monospace; white-space: pre-wrap; }' >> index.html
        echo '.line { margin: 2px 0; }' >> index.html
        echo '.num { color: #6a737d; margin-right: 15px; }' >> index.html
        echo 'a { color: #58a6ff; }' >> index.html
        echo '</style>' >> index.html
        echo '</head>' >> index.html
        echo '<body>' >> index.html
        echo '<div class="container">' >> index.html
        
        # Cabe√ßalho
        echo '<header>' >> index.html
        echo '<h1>üì• C√≥digo Fonte COMPLETO</h1>' >> index.html
        echo '<p>Im√≥veis Macei√≥ - Todas as linhas extra√≠das</p>' >> index.html
        echo "<p>Gerado: $DATE</p>" >> index.html
        echo '</header>' >> index.html
        
        # Estat√≠sticas
        echo '<div class="stats">' >> index.html
        echo '<h2>üìä Estat√≠sticas</h2>' >> index.html
        
        # Contar arquivos e linhas
        TOTAL_LINES=0
        HTML_COUNT=0
        JS_COUNT=0
        CSS_COUNT=0
        JSON_COUNT=0
        
        # Processar HTML
        for file in fonte-completo/*.html fonte-completo/**/*.html 2>/dev/null; do
          if [ -f "$file" ]; then
            HTML_COUNT=$((HTML_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        # Processar JS
        for file in fonte-completo/*.js fonte-completo/**/*.js 2>/dev/null; do
          if [ -f "$file" ]; then
            JS_COUNT=$((JS_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        # Processar CSS
        for file in fonte-completo/*.css fonte-completo/**/*.css 2>/dev/null; do
          if [ -f "$file" ]; then
            CSS_COUNT=$((CSS_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        # Processar JSON
        for file in fonte-completo/*.json fonte-completo/**/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            JSON_COUNT=$((JSON_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        echo "<p><strong>Total de linhas:</strong> $TOTAL_LINES</p>" >> index.html
        echo "<p><strong>Total de arquivos:</strong> $TOTAL_FILES</p>" >> index.html
        echo "<p><strong>HTML:</strong> $HTML_COUNT arquivos</p>" >> index.html
        echo "<p><strong>JavaScript:</strong> $JS_COUNT arquivos</p>" >> index.html
        echo "<p><strong>CSS:</strong> $CSS_COUNT arquivos</p>" >> index.html
        echo "<p><strong>JSON:</strong> $JSON_COUNT arquivos</p>" >> index.html
        echo '<p><strong>Status:</strong> <span style="color: #3fb950;">‚úÖ Completo - Sem limita√ß√µes</span></p>' >> index.html
        echo '</div>' >> index.html
        
        # Mostrar c√≥digo de cada arquivo
        echo '<h2>üìú C√≥digo Fonte Completo</h2>' >> index.html
        echo '<p>Todas as linhas de todos os arquivos:</p>' >> index.html
        
        # HTML files
        if [ $HTML_COUNT -gt 0 ]; then
          echo '<h3>üåê Arquivos HTML</h3>' >> index.html
          for file in fonte-completo/*.html fonte-completo/**/*.html 2>/dev/null; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "<div class='file-section'>" >> index.html
              echo "<h4>$filename</h4>" >> index.html
              echo '<pre>' >> index.html
              line_num=1
              while IFS= read -r line; do
                # Escapar HTML
                line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g')
                echo "<div class='line'><span class='num'>$line_num</span>$line</div>" >> index.html
                line_num=$((line_num + 1))
              done < "$file"
              echo '</pre>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # JS files
        if [ $JS_COUNT -gt 0 ]; then
          echo '<h3>üìú Arquivos JavaScript</h3>' >> index.html
          for file in fonte-completo/*.js fonte-completo/**/*.js 2>/dev/null; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "<div class='file-section'>" >> index.html
              echo "<h4>$filename</h4>" >> index.html
              echo '<pre>' >> index.html
              line_num=1
              while IFS= read -r line; do
                line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g')
                echo "<div class='line'><span class='num'>$line_num</span>$line</div>" >> index.html
                line_num=$((line_num + 1))
              done < "$file"
              echo '</pre>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # CSS files
        if [ $CSS_COUNT -gt 0 ]; then
          echo '<h3>üé® Arquivos CSS</h3>' >> index.html
          for file in fonte-completo/*.css fonte-completo/**/*.css 2>/dev/null; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "<div class='file-section'>" >> index.html
              echo "<h4>$filename</h4>" >> index.html
              echo '<pre>' >> index.html
              line_num=1
              while IFS= read -r line; do
                line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g')
                echo "<div class='line'><span class='num'>$line_num</span>$line</div>" >> index.html
                line_num=$((line_num + 1))
              done < "$file"
              echo '</pre>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # JSON files
        if [ $JSON_COUNT -gt 0 ]; then
          echo '<h3>üìã Arquivos JSON</h3>' >> index.html
          for file in fonte-completo/*.json fonte-completo/**/*.json 2>/dev/null; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "<div class='file-section'>" >> index.html
              echo "<h4>$filename</h4>" >> index.html
              echo '<pre>' >> index.html
              line_num=1
              while IFS= read -r line; do
                line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/\"/\&quot;/g')
                echo "<div class='line'><span class='num'>$line_num</span>$line</div>" >> index.html
                line_num=$((line_num + 1))
              done < "$file"
              echo '</pre>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # Rodap√©
        echo '<footer style="margin-top: 40px; padding: 20px; background: #161b22; border-radius: 8px; text-align: center;">' >> index.html
        echo "<h3>‚úÖ Extra√ß√£o Completa</h3>" >> index.html
        echo "<p>$TOTAL_LINES linhas em $TOTAL_FILES arquivos</p>" >> index.html
        echo "<p>Todas as linhas extra√≠das - Sem limita√ß√µes</p>" >> index.html
        echo "<p>Gerado: $DATE</p>" >> index.html
        echo '<p>' >> index.html
        echo '<a href="https://rclessa25-hub.github.io/imoveis-maceio/">Site Principal</a>' >> index.html
        echo ' | ' >> index.html
        echo '<a href="https://github.com/rclessa25-hub/imoveis-maceio">Reposit√≥rio</a>' >> index.html
        echo '</p>' >> index.html
        echo '</footer>' >> index.html
        
        echo '</div>' >> index.html
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ Relat√≥rio criado!"
        echo "Linhas: $TOTAL_LINES"
        echo "Arquivos: $TOTAL_FILES"
    
    - name: üì¶ Upload para Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar link
      run: |
        echo ""
        echo "‚úÖ RELAT√ìRIO GERADO!"
        echo "===================="
        echo "üåê Dispon√≠vel em:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üìä Extra√ß√£o completa:"
        echo "- Todas as linhas extra√≠das"
        echo "- Sem limita√ß√µes de visualiza√ß√£o"
        echo "- Design responsivo"
        echo "- Navega√ß√£o f√°cil"
