name: üöÄ Gerar Relat√≥rio Completo

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Toda domingo √† meia-noite

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  generate-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: üì• Checkout reposit√≥rio alvo
      uses: actions/checkout@v4
      with:
        repository: rclessa25-hub/imoveis-maceio
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: üìä Analisar projeto
      run: |
        echo "üîç Analisando projeto imoveis-maceio..."
        
        # Coletar estat√≠sticas
        HTML_COUNT=$(find . -name "*.html" | wc -l)
        CSS_COUNT=$(find . -name "*.css" | wc -l)
        JS_COUNT=$(find . -name "*.js" | wc -l)
        TOTAL_FILES=$((HTML_COUNT + CSS_COUNT + JS_COUNT))
        
        # Data atual
        DATA_ATUAL=$(date '+%d/%m/%Y √†s %H:%M')
        
        echo "üìà Estat√≠sticas coletadas"
        echo "- HTML: $HTML_COUNT"
        echo "- CSS: $CSS_COUNT"
        echo "- JavaScript: $JS_COUNT"
        echo "- Total: $TOTAL_FILES arquivos"
        
        # Salvar para usar depois
        echo "HTML_COUNT=$HTML_COUNT" >> $GITHUB_ENV
        echo "CSS_COUNT=$CSS_COUNT" >> $GITHUB_ENV
        echo "JS_COUNT=$JS_COUNT" >> $GITHUB_ENV
        echo "DATA_ATUAL=$DATA_ATUAL" >> $GITHUB_ENV
        echo "TOTAL_FILES=$TOTAL_FILES" >> $GITHUB_ENV
    
    - name: üìÅ Checkout reposit√≥rio de relat√≥rios
      uses: actions/checkout@v4
      with:
        path: './reports-repo'
    
    - name: üåê Gerar relat√≥rio HTML
      run: |
        cd reports-repo
        
        # Criar index.html
        cat > index.html << EOF
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üìä Relat√≥rios - Im√≥veis Macei√≥</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <style>
                :root {
                    --primary: #2ea44f;
                    --secondary: #24292e;
                    --dark: #0d1117;
                    --light: #c9d1d9;
                }
                * { margin: 0; padding: 0; box-sizing: border-box; }
                body {
                    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    background: var(--dark);
                    color: var(--light);
                    line-height: 1.6;
                }
                .container {
                    max-width: 1200px;
                    margin: 0 auto;
                    padding: 20px;
                }
                header {
                    text-align: center;
                    margin-bottom: 40px;
                    padding-bottom: 20px;
                    border-bottom: 2px solid var(--primary);
                }
                h1 { color: var(--primary); }
                .dashboard {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                    gap: 20px;
                    margin: 30px 0;
                }
                .card {
                    background: var(--secondary);
                    padding: 25px;
                    border-radius: 10px;
                    border: 1px solid #30363d;
                }
                .card h3 {
                    color: var(--primary);
                    margin-bottom: 15px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(4, 1fr);
                    gap: 15px;
                    margin: 20px 0;
                }
                .stat-box {
                    text-align: center;
                    padding: 20px;
                    background: var(--secondary);
                    border-radius: 8px;
                }
                .stat-number {
                    font-size: 2.5em;
                    color: var(--primary);
                    font-weight: bold;
                }
                nav {
                    background: var(--secondary);
                    padding: 15px;
                    border-radius: 8px;
                    margin-bottom: 20px;
                }
                nav a {
                    color: var(--light);
                    text-decoration: none;
                    margin-right: 20px;
                }
                nav a:hover { color: var(--primary); }
                pre {
                    background: var(--secondary);
                    padding: 15px;
                    border-radius: 6px;
                    overflow-x: auto;
                    font-family: 'Monaco', 'Courier New', monospace;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <header>
                    <h1><i class="fas fa-chart-line"></i> Relat√≥rios T√©cnicos</h1>
                    <p>Im√≥veis Macei√≥ - An√°lise e Estat√≠sticas</p>
                    <p><small>Gerado em: ${{ env.DATA_ATUAL }}</small></p>
                </header>
                
                <nav>
                    <a href="#stats"><i class="fas fa-chart-bar"></i> Estat√≠sticas</a>
                    <a href="#structure"><i class="fas fa-sitemap"></i> Estrutura</a>
                    <a href="#modules"><i class="fas fa-cubes"></i> M√≥dulos</a>
                    <a href="https://rclessa25-hub.github.io/imoveis-maceio/" target="_blank">
                        <i class="fas fa-external-link-alt"></i> Site Principal
                    </a>
                </nav>
                
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-number">${{ env.HTML_COUNT }}</div>
                        <div>Arquivos HTML</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${{ env.CSS_COUNT }}</div>
                        <div>Estilos CSS</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${{ env.JS_COUNT }}</div>
                        <div>Scripts JS</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number">${{ env.TOTAL_FILES }}</div>
                        <div>Total Arquivos</div>
                    </div>
                </div>
                
                <div class="dashboard">
                    <div class="card">
                        <h3><i class="fas fa-project-diagram"></i> Estrutura do Projeto</h3>
                        <pre><code>$(find . -maxdepth 3 -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" \) | sort | head -20)</code></pre>
                        <p><small>Mostrando 20 principais arquivos</small></p>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-cubes"></i> M√≥dulos JavaScript</h3>
                        <ul style="list-style: none; padding: 0;">
                            <li>‚úÖ <strong>admin.js</strong> - Painel administrativo</li>
                            <li>‚úÖ <strong>gallery.js</strong> - Galeria de imagens</li>
                            <li>‚úÖ <strong>properties.js</strong> - Gest√£o de im√≥veis</li>
                            <li>‚úÖ <strong>supabase.js</strong> - Integra√ß√£o banco</li>
                            <li>‚úÖ <strong>utils.js</strong> - Fun√ß√µes utilit√°rias</li>
                        </ul>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-chart-pie"></i> Distribui√ß√£o</h3>
                        <canvas id="chart" width="400" height="200"></canvas>
                    </div>
                    
                    <div class="card">
                        <h3><i class="fas fa-external-link-alt"></i> Links R√°pidos</h3>
                        <div style="display: flex; flex-direction: column; gap: 10px;">
                            <a href="https://rclessa25-hub.github.io/imoveis-maceio/" target="_blank" style="color: var(--primary);">
                                <i class="fas fa-rocket"></i> Site Principal
                            </a>
                            <a href="https://github.com/rclessa25-hub/imoveis-maceio" target="_blank" style="color: var(--primary);">
                                <i class="fab fa-github"></i> Reposit√≥rio
                            </a>
                            <a href="https://syztbxvpdaplpetmixmt.supabase.co" target="_blank" style="color: var(--primary);">
                                <i class="fas fa-database"></i> Supabase
                            </a>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3><i class="fas fa-sync-alt"></i> Atualiza√ß√£o Autom√°tica</h3>
                    <p>Este relat√≥rio √© atualizado automaticamente:</p>
                    <ul>
                        <li>‚úÖ Toda <strong>domingo √† meia-noite</strong></li>
                        <li>‚úÖ Execu√ß√£o <strong>manual</strong> a qualquer momento</li>
                        <li>‚úÖ Dispon√≠vel 24/7 via GitHub Pages</li>
                    </ul>
                </div>
            </div>
            
            <script>
                // Gr√°fico
                const ctx = document.getElementById('chart').getContext('2d');
                new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['HTML', 'CSS', 'JavaScript'],
                        datasets: [{
                            data: [${{ env.HTML_COUNT }}, ${{ env.CSS_COUNT }}, ${{ env.JS_COUNT }}],
                            backgroundColor: ['#2ea44f', '#58a6ff', '#f78166']
                        }]
                    }
                });
            </script>
        </body>
        </html>
        EOF
        
        echo "‚úÖ Relat√≥rio HTML gerado"
    
    - name: üöÄ Configurar Pages
      uses: actions/configure-pages@v3
    
    - name: üì§ Upload artefato
      uses: actions/upload-pages-artifact@v2
      with:
        path: './reports-repo'
    
    - name: üåê Publicar
      id: deployment
      uses: actions/deploy-pages@v2
    
    - name: ‚úÖ Conclus√£o
      run: |
        echo "üéâ RELAT√ìRIOS GERADOS COM SUCESSO!"
        echo "üåê Acesse: https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo "üìä Atualiza√ß√£o autom√°tica configurada"
        echo "üîÑ Pr√≥xima execu√ß√£o autom√°tica: Domingo √† meia-noite"
