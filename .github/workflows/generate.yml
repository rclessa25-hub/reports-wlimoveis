name: üìä Gerar Relat√≥rio Anal√≠tico

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'  # Todo domingo √† meia-noite
  push:
    branches:
      - main
    paths:
      - '**.js'
      - '**.html'
      - '**.css'
      - '**.json'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  analyze-and-report:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    steps:
    - name: üì• Checkout projeto principal
      uses: actions/checkout@v4
      with:
        repository: rclessa25-hub/imoveis-maceio
        token: ${{ secrets.GITHUB_TOKEN }}
        path: 'source-project'
    
    - name: üì• Checkout reposit√≥rio de relat√≥rios
      uses: actions/checkout@v4
      with:
        repository: rclessa25-hub/reports-wlimoveis
        path: 'reports-repo'
        ref: gh-pages
    
    - name: üêç Configurar Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: üìä Executar an√°lise
      run: |
        cd source-project
        python -c "
        import json
        import subprocess
        import datetime
        import os
        
        print('üîç Analisando estrutura do projeto...')
        
        # Coletar dados b√°sicos
        stats = {
            'date': datetime.datetime.now().strftime('%d/%m/%Y √†s %H:%M:%S'),
            'iso_date': datetime.datetime.now().isoformat()
        }
        
        # Contar arquivos
        import glob
        stats['files'] = {
            'html': len(glob.glob('**/*.html', recursive=True)),
            'css': len(glob.glob('**/*.css', recursive=True)),
            'js': len(glob.glob('**/*.js', recursive=True)),
            'json': len(glob.glob('**/*.json', recursive=True)),
            'images': len(glob.glob('**/*.png', recursive=True)) + 
                     len(glob.glob('**/*.jpg', recursive=True)) +
                     len(glob.glob('**/*.jpeg', recursive=True))
        }
        
        # Salvar dados
        with open('../stats.json', 'w') as f:
            json.dump(stats, f, indent=2)
        
        print('‚úÖ An√°lise conclu√≠da')
        "
    
    - name: üìù Gerar relat√≥rio HTML
      run: |
        cd reports-repo
        
        # Ler estat√≠sticas
        if [ -f ../stats.json ]; then
          STATS=$(cat ../stats.json)
        else
          STATS='{"date":"N/A","files":{"html":0,"css":0,"js":0,"json":0,"images":0}}'
        fi
        
        # Gerar HTML simples
        cat > index.html << 'HTML'
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>üìã Relat√≥rio - Im√≥veis Macei√≥</title>
            <style>
                body { font-family: Arial, sans-serif; margin: 20px; }
                .card { border: 1px solid #ddd; padding: 20px; margin: 10px 0; border-radius: 5px; }
                .stat { display: inline-block; margin: 10px; padding: 15px; background: #f0f0f0; }
                .number { font-size: 2em; font-weight: bold; color: #2ea44f; }
            </style>
        </head>
        <body>
            <h1>üìä Relat√≥rio Anal√≠tico</h1>
            <h2>Im√≥veis Macei√≥ - An√°lise Estrutural</h2>
            
            <div id="stats">
                <h3>Estat√≠sticas:</h3>
                <div class="stat">
                    <div class="number" id="html-count">0</div>
                    <div>HTML</div>
                </div>
                <div class="stat">
                    <div class="number" id="css-count">0</div>
                    <div>CSS</div>
                </div>
                <div class="stat">
                    <div class="number" id="js-count">0</div>
                    <div>JavaScript</div>
                </div>
                <div class="stat">
                    <div class="number" id="json-count">0</div>
                    <div>JSON</div>
                </div>
            </div>
            
            <div class="card">
                <h3>Estrutura do Projeto:</h3>
                <pre id="tree-view">Carregando...</pre>
            </div>
            
            <script>
                // Dados do relat√≥rio
                const stats = $STATS;
                
                // Atualizar estat√≠sticas
                document.getElementById('html-count').textContent = stats.files.html || 0;
                document.getElementById('css-count').textContent = stats.files.css || 0;
                document.getElementById('js-count').textContent = stats.files.js || 0;
                document.getElementById('json-count').textContent = stats.files.json || 0;
                
                // Data de gera√ß√£o
                document.body.innerHTML += `<p><strong>Gerado em:</strong> ${stats.date || 'N/A'}</p>`;
            </script>
        </body>
        </html>
        HTML
        
        # Gerar tamb√©m um JSON com mais detalhes
        echo "$STATS" > data.json
        
        echo "‚úÖ Relat√≥rio gerado"
    
    - name: üìÇ Listar estrutura do projeto
      run: |
        cd source-project
        echo "üìÅ ESTRUTURA COMPLETA:"
        echo "====================="
        find . -type f -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.json" | sort > ../file-list.txt
        cat ../file-list.txt
        
        # Salvar em markdown tamb√©m
        echo "# Lista de Arquivos" > ../files.md
        echo "\`\`\`" >> ../files.md
        cat ../file-list.txt >> ../files.md
        echo "\`\`\`" >> ../files.md
    
    - name: üìÑ Gerar relat√≥rio markdown
      run: |
        cd reports-repo
        
        cat > README.md << 'MD'
        # üìã Relat√≥rio Anal√≠tico - Im√≥veis Macei√≥
        
        ## Informa√ß√µes do Projeto
        - **Nome:** Sistema de Gest√£o de Im√≥veis Macei√≥
        - **URL:** https://rclessa25-hub.github.io/imoveis-maceio/
        - **Reposit√≥rio:** https://github.com/rclessa25-hub/imoveis-maceio
        - **Tecnologias:** HTML5, CSS3, JavaScript, Supabase
        
        ## Estrutura de Arquivos
        MD
        
        cat ../files.md >> README.md
        
        echo "## üìä Estat√≠sticas" >> README.md
        echo "\`\`\`json" >> README.md
        cat ../stats.json >> README.md
        echo "\`\`\`" >> README.md
        
        echo "‚úÖ Relat√≥rio Markdown gerado"
    
    - name: üì§ Publicar no GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./reports-repo
        publish_branch: gh-pages
        force_orphan: true
    
    - name: üì¢ Notifica√ß√£o
      run: |
        echo "üéâ RELAT√ìRIO PUBLICADO COM SUCESSO!"
        echo "==================================="
        echo ""
        echo "üåê ACESSO P√öBLICO:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üìä RELAT√ìRIO COMPLETO INCLUI:"
        echo "1. HTML interativo com estat√≠sticas"
        echo "2. Markdown com estrutura completa"
        echo "3. JSON com dados brutos"
        echo ""
        echo "üîÑ ATUALIZA√á√ÉO AUTOM√ÅTICA:"
        echo "- Todo domingo √† meia-noite"
        echo "- A cada push no reposit√≥rio principal"
