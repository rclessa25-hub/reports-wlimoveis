name: üì• Extrair C√≥digo Fonte

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto principal
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        echo "========================="
        
        # Clonar o projeto principal
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
        
        echo "‚úÖ Projeto clonado com sucesso!"
        echo "üìÅ Arquivos encontrados:"
        find fonte-completo -type f -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" | sort
    
    - name: üìù Criar relat√≥rio com c√≥digo real
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO COM C√ìDIGO REAL..."
        echo "======================================"
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Criar √≠ndice principal
        echo '<!DOCTYPE html>' > index.html
        echo '<html lang="pt-BR">' >> index.html
        echo '<head>' >> index.html
        echo '<meta charset="UTF-8">' >> index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
        echo '<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥</title>' >> index.html
        echo '<style>' >> index.html
        echo 'body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }' >> index.html
        echo '.container { max-width: 1400px; margin: 0 auto; }' >> index.html
        echo 'header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }' >> index.html
        echo 'h1 { color: #2ea44f; font-size: 2.5em; }' >> index.html
        echo 'h2 { color: #58a6ff; margin: 30px 0 20px; }' >> index.html
        echo '.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }' >> index.html
        echo '.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }' >> index.html
        echo '.file-card h3 { margin-top: 0; color: #58a6ff; }' >> index.html
        echo '.file-card .js { color: #f1e05a; }' >> index.html
        echo '.file-card .css { color: #563d7c; }' >> index.html
        echo '.file-card .html { color: #e34c26; }' >> index.html
        echo '.file-card .json { color: #f1e05a; opacity: 0.8; }' >> index.html
        echo '.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }' >> index.html
        echo 'pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }' >> index.html
        echo '.line-number { color: #6a737d; margin-right: 15px; user-select: none; }' >> index.html
        echo '.comment { color: #6a737d; }' >> index.html
        echo '.string { color: #9ecbff; }' >> index.html
        echo '.keyword { color: #ff7b72; }' >> index.html
        echo '.function { color: #d2a8ff; }' >> index.html
        echo 'a { color: #2ea44f; text-decoration: none; }' >> index.html
        echo 'a:hover { text-decoration: underline; }' >> index.html
        echo '</style>' >> index.html
        echo '</head>' >> index.html
        echo '<body>' >> index.html
        echo '<div class="container">' >> index.html
        echo '<header>' >> index.html
        echo '<h1>üì• C√≥digo Fonte Completo</h1>' >> index.html
        echo '<p>Im√≥veis Macei√≥ - Extra√ß√£o Real dos Arquivos</p>' >> index.html
        echo '<p><strong>Gerado em:</strong> '"$DATE_NOW"'</p>' >> index.html
        echo '</header>' >> index.html
        
        # LISTA DE ARQUIVOS
        echo '<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>' >> index.html
        echo '<div class="file-list">' >> index.html
        
        # Adicionar cada arquivo √† lista
        for file in fonte-completo/*.html fonte-completo/*.js fonte-completo/*.css fonte-completo/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            extension="${filename##*.}"
            
            case $extension in
              "html")
                class="html"
                icon="üìÑ"
                ;;
              "js")
                class="js"
                icon="üìú"
                ;;
              "css")
                class="css"
                icon="üé®"
                ;;
              "json")
                class="json"
                icon="üìã"
                ;;
              *)
                class=""
                icon="üìÅ"
                ;;
            esac
            
            # Contar linhas
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>'"$icon <span class=\"$class\">$filename</span>"'</h3>' >> index.html
            echo '<p><strong>Local:</strong> '"$(dirname "$file")"'</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '<p><a href="#'"${filename}"'">Ver c√≥digo completo ‚Üí</a></p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # Arquivos em subpastas
        for file in fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/css/*.css; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            extension="${filename##*.}"
            relative_path=${file#fonte-completo/}
            
            case $extension in
              "js")
                class="js"
                icon="üìú"
                ;;
              "css")
                class="css"
                icon="üé®"
                ;;
              *)
                class=""
                icon="üìÅ"
                ;;
            esac
            
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>'"$icon <span class=\"$class\">$filename</span>"'</h3>' >> index.html
            echo '<p><strong>Local:</strong> '"$(dirname "$relative_path")"'</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '<p><a href="#'"${filename}-$(echo $relative_path | tr '/' '-')"'">Ver c√≥digo completo ‚Üí</a></p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        # C√ìDIGO COMPLETO DOS ARQUIVOS
        echo '<h2>üìú C√≥digo Fonte Completo</h2>' >> index.html
        
        # 1. index.html
        if [ -f "fonte-completo/index.html" ]; then
          echo '<div class="code-viewer" id="index.html">' >> index.html
          echo '<h3>üìÑ index.html</h3>' >> index.html
          echo '<pre>' >> index.html
          # Ler e mostrar as primeiras 200 linhas
          head -200 fonte-completo/index.html | cat -n | while read num line; do
            # Escapar HTML
            line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            echo '<span class="line-number">'"$num"'</span>'"$line<br/>" >> index.html
          done
          echo '</pre>' >> index.html
          echo '<p><em>Mostrando 200 primeiras linhas de '"$(wc -l < fonte-completo/index.html)"' no total</em></p>' >> index.html
          echo '</div>' >> index.html
        fi
        
        # 2. main.js
        if [ -f "fonte-completo/js/main.js" ]; then
          echo '<div class="code-viewer" id="main.js-js-main">' >> index.html
          echo '<h3>üìú js/main.js</h3>' >> index.html
          echo '<pre>' >> index.html
          cat fonte-completo/js/main.js | cat -n | while read num line; do
            line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            echo '<span class="line-number">'"$num"'</span>'"$line<br/>" >> index.html
          done
          echo '</pre>' >> index.html
          echo '</div>' >> index.html
        fi
        
        # 3. M√≥dulos JS
        echo '<h3>üß© M√≥dulos JavaScript</h3>' >> index.html
        
        for module in fonte-completo/js/modules/*.js; do
          if [ -f "$module" ]; then
            module_name=$(basename "$module")
            echo '<div class="code-viewer" id="'"$module_name"'-js-modules">' >> index.html
            echo '<h3>üìú js/modules/'"$module_name"'</h3>' >> index.html
            echo '<pre>' >> index.html
            cat "$module" | head -150 | cat -n | while read num line; do
              line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              # Destacar sintaxe b√°sica
              line=$(echo "$line" | sed 's/\/\/.*$/<span class="comment">&<\/span>/')
              line=$(echo "$line" | sed 's/"[^"]*"/<span class="string">&<\/span>/g')
              echo '<span class="line-number">'"$num"'</span>'"$line<br/>" >> index.html
            done
            echo '</pre>' >> index.html
            total_lines=$(wc -l < "$module")
            if [ "$total_lines" -gt 150 ]; then
              echo '<p><em>Mostrando 150 primeiras linhas de '"$total_lines"' no total</em></p>' >> index.html
            fi
            echo '</div>' >> index.html
          fi
        done
        
        # 4. Componentes JS
        echo '<h3>üß© Componentes JavaScript</h3>' >> index.html
        
        for component in fonte-completo/js/components/*.js; do
          if [ -f "$component" ]; then
            component_name=$(basename "$component")
            echo '<div class="code-viewer" id="'"$component_name"'-js-components">' >> index.html
            echo '<h3>üìú js/components/'"$component_name"'</h3>' >> index.html
            echo '<pre>' >> index.html
            cat "$component" | cat -n | while read num line; do
              line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              line=$(echo "$line" | sed 's/\/\/.*$/<span class="comment">&<\/span>/')
              echo '<span class="line-number">'"$num"'</span>'"$line<br/>" >> index.html
            done
            echo '</pre>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # 5. Arquivos CSS
        echo '<h3>üé® Arquivos CSS</h3>' >> index.html
        
        for css_file in fonte-completo/css/*.css; do
          if [ -f "$css_file" ]; then
            css_name=$(basename "$css_file")
            echo '<div class="code-viewer" id="'"$css_name"'-css">' >> index.html
            echo '<h3>üé® css/'"$css_name"'</h3>' >> index.html
            echo '<pre>' >> index.html
            cat "$css_file" | head -100 | cat -n | while read num line; do
              line=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              echo '<span class="line-number">'"$num"'</span>'"$line<br/>" >> index.html
            done
            echo '</pre>' >> index.html
            total_lines=$(wc -l < "$css_file")
            if [ "$total_lines" -gt 100 ]; then
              echo '<p><em>Mostrando 100 primeiras linhas de '"$total_lines"' no total</em></p>' >> index.html
            fi
            echo '</div>' >> index.html
          fi
        done
        
        # RESUMO
        echo '<div style="background: #161b22; padding: 25px; border-radius: 10px; margin: 40px 0;">' >> index.html
        echo '<h2>üìä Resumo da Extra√ß√£o</h2>' >> index.html
        
        # Contar arquivos
        html_count=$(find fonte-completo -name "*.html" -type f | wc -l)
        js_count=$(find fonte-completo -name "*.js" -type f | wc -l)
        css_count=$(find fonte-completo -name "*.css" -type f | wc -l)
        json_count=$(find fonte-completo -name "*.json" -type f | wc -l)
        
        echo '<p><strong>Total de arquivos extra√≠dos:</strong> '"$((html_count + js_count + css_count + json_count))"'</p>' >> index.html
        echo '<p><strong>HTML:</strong> '"$html_count"' arquivos</p>' >> index.html
        echo '<p><strong>JavaScript:</strong> '"$js_count"' arquivos</p>' >> index.html
        echo '<p><strong>CSS:</strong> '"$css_count"' arquivos</p>' >> index.html
        echo '<p><strong>JSON:</strong> '"$json_count"' arquivos</p>' >> index.html
        
        # Calcular linhas totais
        total_lines=0
        for file in $(find fonte-completo -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" -type f); do
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          total_lines=$((total_lines + lines))
        done
        
        echo '<p><strong>Linhas de c√≥digo totais:</strong> '"$total_lines"'</p>' >> index.html
        echo '<p><strong>Status:</strong> <span style="color: #2ea44f;">‚óè Extra√ß√£o completa</span></p>' >> index.html
        echo '</div>' >> index.html
        
        # FOOTER
        echo '<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">' >> index.html
        echo '<p><strong>üì• Extra√ß√£o Completa do C√≥digo Fonte</strong></p>' >> index.html
        echo '<p>Gerado automaticamente em '"$DATE_NOW"'</p>' >> index.html
        echo '<div style="margin-top: 15px;">' >> index.html
        echo '<a href="https://rclessa25-hub.github.io/imoveis-maceio/" style="color: #2ea44f; margin: 0 10px;">' >> index.html
        echo '<i class="fas fa-external-link-alt"></i> Site Principal' >> index.html
        echo '</a>' >> index.html
        echo '<a href="https://github.com/rclessa25-hub/imoveis-maceio" style="color: #2ea44f; margin: 0 10px;">' >> index.html
        echo '<i class="fab fa-github"></i> Reposit√≥rio Original' >> index.html
        echo '</a>' >> index.html
        echo '</div>' >> index.html
        echo '</footer>' >> index.html
        
        echo '</div>' >> index.html
        
        # Script para destaque de sintaxe
        echo '<script>' >> index.html
        echo '// Destacar palavras-chave JavaScript' >> index.html
        echo 'const keywords = ["function", "const", "let", "var", "class", "import", "export", "async", "await", "return", "if", "else", "for", "while", "try", "catch", "throw"];' >> index.html
        echo 'document.querySelectorAll(".code-viewer pre").forEach(pre => {' >> index.html
        echo '    let html = pre.innerHTML;' >> index.html
        echo '    keywords.forEach(keyword => {' >> index.html
        echo '        const regex = new RegExp(`\\\\b${keyword}\\\\b`, "g");' >> index.html
        echo '        html = html.replace(regex, `<span class="keyword">${keyword}</span>`);' >> index.html
        echo '    });' >> index.html
        echo '    // Destacar fun√ß√µes' >> index.html
        echo '    html = html.replace(/(\\w+)\\s*\\(/g, `<span class="function">$1</span>(`);' >> index.html
        echo '    pre.innerHTML = html;' >> index.html
        echo '});' >> index.html
        echo '</script>' >> index.html
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ Relat√≥rio com c√≥digo real gerado!"
        
        # Mostrar estat√≠sticas
        echo ""
        echo "üìä ESTAT√çSTICAS DA EXTRA√á√ÉO:"
        echo "============================"
        echo "HTML: $html_count arquivos"
        echo "JavaScript: $js_count arquivos"
        echo "CSS: $css_count arquivos"
        echo "Total de linhas: $total_lines"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ C√ìDIGO FONTE EXTRA√çDO!"
        echo "========================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üì• AGORA COM:"
        echo "1. üìÑ C√≥digo REAL do index.html"
        echo "2. üìú Todos os m√≥dulos JavaScript"
        echo "3. üé® Arquivos CSS completos"
        echo "4. üìä Estat√≠sticas reais"
        echo "5. üîç Visualiza√ß√£o com numera√ß√£o de linhas"
