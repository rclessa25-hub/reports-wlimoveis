name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto e verificar conte√∫do
      run: |
        echo "üì• CLONANDO E VERIFICANDO C√ìDIGO FONTE..."
        echo "========================================="
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
        
        echo ""
        echo "üîç VERIFICANDO CONTE√öDO DOS ARQUIVOS JS..."
        echo "========================================"
        
        # Verificar conte√∫do real dos arquivos
        for js_file in fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js 2>/dev/null; do
          if [ -f "$js_file" ]; then
            filename=$(basename "$js_file")
            lines=$(wc -l < "$js_file" 2>/dev/null || echo "0")
            size=$(wc -c < "$js_file" 2>/dev/null || echo "0")
            
            echo "üìú $filename:"
            echo "   Linhas: $lines"
            echo "   Tamanho: $size bytes"
            
            if [ "$lines" -gt 0 ] && [ "$lines" -lt 10 ]; then
              echo "   Conte√∫do (primeiras $lines linhas):"
              cat "$js_file" | sed 's/^/     /'
            elif [ "$lines" -ge 10 ]; then
              echo "   Conte√∫do (primeiras 3 linhas):"
              head -3 "$js_file" | sed 's/^/     /'
            fi
            echo ""
          fi
        done
    
    - name: üìù Criar relat√≥rio com verifica√ß√£o melhorada
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO COM VERIFICA√á√ÉO MELHORADA..."
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # M√©todo MELHORADO para contar fun√ß√µes
        echo "Calculando estat√≠sticas com contagem melhorada..."
        
        # Inicializar contadores
        HTML_COUNT=0
        JS_COUNT=0
        CSS_COUNT=0
        JSON_COUNT=0
        TOTAL_LINES=0
        TOTAL_FUNCTIONS=0
        
        # Fun√ß√£o MELHORADA para contar fun√ß√µes
        count_functions_better() {
          local file="$1"
          local count=0
          
          if [[ "$file" == *.js ]] && [ -f "$file" ] && [ -s "$file" ]; then
            # Contar diferentes tipos de fun√ß√µes
            # 1. function declarations tradicionais
            local func1=$(grep -c "function[[:space:]]" "$file" 2>/dev/null || echo "0")
            
            # 2. arrow functions (const/let/var x = () => {})
            local func2=$(grep -c "=>" "$file" 2>/dev/null || echo "0")
            
            # 3. m√©todos em classes/objetos
            local func3=$(grep -c ")[[:space:]]*{" "$file" 2>/dev/null || echo "0")
            
            # Soma total (evita dupla contagem)
            count=$((func1 + func2))
            
            # Se ambas as contagens forem positivas, pode haver sobreposi√ß√£o
            # Usar o maior valor
            if [ "$func1" -gt 0 ] && [ "$func2" -gt 0 ]; then
              if [ "$func1" -gt "$func2" ]; then
                count=$func1
              else
                count=$func2
              fi
            fi
            
            # Adicionar m√©todos se n√£o foram contados
            if [ "$func3" -gt "$count" ]; then
              count=$func3
            fi
          fi
          
          echo "$count"
        }
        
        # Processar cada tipo separadamente
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            HTML_COUNT=$((HTML_COUNT + 1))
            L=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + L))
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              CSS_COUNT=$((CSS_COUNT + 1))
              L=$(wc -l < "$file" 2>/dev/null || echo "0")
              TOTAL_LINES=$((TOTAL_LINES + L))
            fi
          done
        fi
        
        # JavaScript - contagem MELHORADA
        # JS na raiz
        for file in fonte-completo/js/*.js; do
          if [ -f "$file" ]; then
            JS_COUNT=$((JS_COUNT + 1))
            L=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + L))
            # Contar fun√ß√µes com m√©todo melhorado
            F=$(count_functions_better "$file")
            TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
            
            # Debug: mostrar contagem por arquivo
            if [ "$L" -gt 0 ]; then
              echo "üîç $(basename "$file"): $L linhas, $F fun√ß√µes"
            fi
          fi
        done
        
        # M√≥dulos JS
        if [ -d "fonte-completo/js/modules" ]; then
          for file in fonte-completo/js/modules/*.js; do
            if [ -f "$file" ]; then
              JS_COUNT=$((JS_COUNT + 1))
              L=$(wc -l < "$file" 2>/dev/null || echo "0")
              TOTAL_LINES=$((TOTAL_LINES + L))
              F=$(count_functions_better "$file")
              TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
              
              if [ "$L" -gt 0 ]; then
                echo "üîç modules/$(basename "$file"): $L linhas, $F fun√ß√µes"
              fi
            fi
          done
        fi
        
        # Componentes JS
        if [ -d "fonte-completo/js/components" ]; then
          for file in fonte-completo/js/components/*.js; do
            if [ -f "$file" ]; then
              JS_COUNT=$((JS_COUNT + 1))
              L=$(wc -l < "$file" 2>/dev/null || echo "0")
              TOTAL_LINES=$((TOTAL_LINES + L))
              F=$(count_functions_better "$file")
              TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
              
              if [ "$L" -gt 0 ]; then
                echo "üîç components/$(basename "$file"): $L linhas, $F fun√ß√µes"
              fi
            fi
          done
        fi
        
        # JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            JSON_COUNT=$((JSON_COUNT + 1))
            L=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + L))
          fi
        done
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        echo ""
        echo "üìä RESUMO DAS CONTAGENS:"
        echo "========================"
        echo "Arquivos JS processados: $JS_COUNT"
        echo "Total de fun√ß√µes detectadas: $TOTAL_FUNCTIONS"
        echo "Arquivos com 1 linha: $(find fonte-completo -name "*.js" -type f -exec sh -c 'test $(wc -l < "$1") -eq 1' _ {} \; -print | wc -l)"
        
        # CRIAR HTML
        echo "Criando HTML..."
        
        # Criar arquivo vazio
        > index.html
        
        # Adicionar header
        echo '<!DOCTYPE html>' >> index.html
        echo '<html lang="pt-BR">' >> index.html
        echo '<head>' >> index.html
        echo '<meta charset="UTF-8">' >> index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
        echo '<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥ (AN√ÅLISE DETALHADA)</title>' >> index.html
        echo '<style>' >> index.html
        echo 'body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }' >> index.html
        echo '.container { max-width: 1400px; margin: 0 auto; }' >> index.html
        echo 'header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }' >> index.html
        echo 'h1 { color: #2ea44f; font-size: 2.5em; }' >> index.html
        echo 'h2 { color: #58a6ff; margin: 30px 0 20px; }' >> index.html
        echo '.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 15px; margin: 20px 0; }' >> index.html
        echo '.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }' >> index.html
        echo '.file-card h3 { margin-top: 0; color: #58a6ff; }' >> index.html
        echo '.file-card .empty { color: #f85149; }' >> index.html
        echo '.file-card .small { color: #d29922; }' >> index.html
        echo '.file-card .normal { color: #58a6ff; }' >> index.html
        echo '.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }' >> index.html
        echo 'pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }' >> index.html
        echo '.line-number { color: #6a737d; margin-right: 15px; user-select: none; }' >> index.html
        echo '.functions-badge { background: #1f6feb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }' >> index.html
        echo '.warning-badge { background: #d29922; color: black; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }' >> index.html
        echo '</style>' >> index.html
        echo '</head>' >> index.html
        echo '<body>' >> index.html
        echo '<div class="container">' >> index.html
        echo '<header>' >> index.html
        echo '<h1>üì• C√≥digo Fonte - An√°lise Detalhada</h1>' >> index.html
        echo '<p>Im√≥veis Macei√≥ - Verifica√ß√£o completa de conte√∫do</p>' >> index.html
        echo '<p><strong>Gerado em:</strong> '"$DATE_NOW"'</p>' >> index.html
        echo '</header>' >> index.html
        
        # Adicionar an√°lise de conte√∫do
        echo '<h2>üìä An√°lise de Conte√∫do dos Arquivos</h2>' >> index.html
        echo '<div style="background: #161b22; padding: 20px; border-radius: 8px; margin: 20px 0;">' >> index.html
        echo '<p><strong>Total de arquivos:</strong> '"$TOTAL_FILES"'</p>' >> index.html
        echo '<p><strong>Total de linhas:</strong> '"$TOTAL_LINES"'</p>' >> index.html
        echo '<p><strong>Fun√ß√µes JavaScript detectadas:</strong> '"$TOTAL_FUNCTIONS"'</p>' >> index.html
        echo '<p><strong>HTML:</strong> '"$HTML_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>JavaScript:</strong> '"$JS_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>CSS:</strong> '"$CSS_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>JSON:</strong> '"$JSON_COUNT"' arquivos</p>' >> index.html
        
        # Contar arquivos JS por tamanho
        JS_EMPTY=0
        JS_SMALL=0
        JS_NORMAL=0
        
        for file in fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js 2>/dev/null; do
          if [ -f "$file" ]; then
            L=$(wc -l < "$file" 2>/dev/null || echo "0")
            if [ "$L" -eq 0 ]; then
              JS_EMPTY=$((JS_EMPTY + 1))
            elif [ "$L" -le 5 ]; then
              JS_SMALL=$((JS_SMALL + 1))
            else
              JS_NORMAL=$((JS_NORMAL + 1))
            fi
          fi
        done
        
        echo '<p><strong>Arquivos JS vazios (0 linhas):</strong> '"$JS_EMPTY"'</p>' >> index.html
        echo '<p><strong>Arquivos JS pequenos (1-5 linhas):</strong> '"$JS_SMALL"'</p>' >> index.html
        echo '<p><strong>Arquivos JS normais (&gt;5 linhas):</strong> '"$JS_NORMAL"'</p>' >> index.html
        echo '</div>' >> index.html
        
        # Lista de arquivos
        echo '<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>' >> index.html
        echo '<div class="file-list">' >> index.html
        
        # Adicionar cada arquivo
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>üìÑ '"$filename"'</h3>' >> index.html
            echo '<p><strong>Local:</strong> .</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Fun√ß√µes:</strong> N/A (HTML)</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file" 2>/dev/null || echo "0")
              size=$(wc -c < "$file" 2>/dev/null || echo "0")
              size_kb=$((size / 1024))
              
              echo '<div class="file-card">' >> index.html
              echo '<h3>üé® '"$filename"'</h3>' >> index.html
              echo '<p><strong>Local:</strong> css</p>' >> index.html
              echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
              echo '<p><strong>Fun√ß√µes:</strong> N/A (CSS)</p>' >> index.html
              echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # JavaScript com classifica√ß√£o
        for file in fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            functions=$(count_functions_better "$file")
            
            # Determinar tipo
            type="JavaScript"
            if [[ "$file" == *"modules"* ]]; then
              type="M√≥dulo JS"
            elif [[ "$file" == *"components"* ]]; then
              type="Componente JS"
            fi
            
            # Determinar classe baseada no tamanho
            if [ "$lines" -eq 0 ]; then
              size_class="empty"
              size_status="üîÑ VAZIO"
            elif [ "$lines" -le 5 ]; then
              size_class="small"
              size_status="üìù PEQUENO"
            else
              size_class="normal"
              size_status="üì¶ NORMAL"
            fi
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>üìú '"$filename"' <small>('"$type"')</small></h3>' >> index.html
            echo '<p><strong>Local:</strong> '"$(dirname "${file#fonte-completo/}")"'</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"' <span class="'"$size_class"'">('"$size_status"')</span></p>' >> index.html
            
            if [ "$lines" -gt 0 ]; then
              if [ "$functions" -gt 0 ]; then
                echo '<p><strong>Fun√ß√µes:</strong> <span class="functions-badge">'"$functions"' fun√ß√£o(√µes)</span></p>' >> index.html
              else
                echo '<p><strong>Fun√ß√µes:</strong> <span class="warning-badge">Nenhuma fun√ß√£o detectada</span></p>' >> index.html
              fi
            else
              echo '<p><strong>Fun√ß√µes:</strong> Arquivo vazio</p>' >> index.html
            fi
            
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            
            # Mostrar preview para arquivos pequenos
            if [ "$lines" -gt 0 ] && [ "$lines" -le 10 ]; then
              echo '<p><strong>Preview:</strong> <code style="color:#8b949e; font-size:0.9em;">' >> index.html
              head -5 "$file" | sed 's/</\&lt;/g; s/>/\&gt;/g' | tr '\n' ' ' >> index.html
              echo '</code></p>' >> index.html
            fi
            
            echo '</div>' >> index.html
          fi
        done
        
        # JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>üìã '"$filename"'</h3>' >> index.html
            echo '<p><strong>Local:</strong> .</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Fun√ß√µes:</strong> N/A (JSON)</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        # C√≥digo completo
        echo '<h2>üìú C√≥digo Fonte Completo</h2>' >> index.html
        
        # Adicionar c√≥digo de cada arquivo
        for file in fonte-completo/*.html fonte-completo/css/*.css fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            
            echo '<div class="code-viewer">' >> index.html
            echo '<h3>'"$(dirname "${file#fonte-completo/}")"'/'"$filename"' ('"$lines"' linhas)</h3>' >> index.html
            echo '<pre>' >> index.html
            
            line_num=1
            while IFS= read -r line; do
              line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              echo '<span class="line-number">'"$line_num"'</span>'"$line_escaped"'<br/>' >> index.html
              line_num=$((line_num + 1))
            done < "$file"
            
            echo '</pre>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # Footer
        echo '<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">' >> index.html
        echo '<p><strong>üì• An√°lise Detalhada do C√≥digo Fonte</strong></p>' >> index.html
        echo '<p>Verifica√ß√£o completa de conte√∫do e fun√ß√µes</p>' >> index.html
        echo '</footer>' >> index.html
        echo '</div>' >> index.html
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ Relat√≥rio de an√°lise criado com sucesso!"
        echo ""
        echo "üìä AN√ÅLISE DETALHADA:"
        echo "===================="
        echo "Arquivos: $TOTAL_FILES"
        echo "Linhas: $TOTAL_LINES"
        echo "Fun√ß√µes JS: $TOTAL_FUNCTIONS"
        echo "Arquivos JS vazios: $JS_EMPTY"
        echo "Arquivos JS pequenos (1-5 linhas): $JS_SMALL"
        echo "Arquivos JS normais (>5 linhas): $JS_NORMAL"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO DE AN√ÅLISE CRIADO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "üîç AGORA COM AN√ÅLISE DETALHADA:"
        echo "‚Ä¢ ‚úÖ Verifica√ß√£o de conte√∫do real"
        echo "‚Ä¢ üìä Classifica√ß√£o por tamanho"
        echo "‚Ä¢ ‚ö° Contagem MELHORADA de fun√ß√µes"
        echo "‚Ä¢ üè∑Ô∏è Identifica√ß√£o de arquivos vazios/pequenos"
        echo "‚Ä¢ üëÅÔ∏è Preview do conte√∫do para arquivos pequenos"
