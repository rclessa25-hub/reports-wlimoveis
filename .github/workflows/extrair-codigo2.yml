name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        echo "========================="
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
    
    - name: üìù Criar relat√≥rio
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO..."
        echo "======================"
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Calcular estat√≠sticas de forma segura
        echo "üîç Calculando estat√≠sticas..."
        
        # Inicializar contadores
        HTML_COUNT=0
        JS_COUNT=0
        CSS_COUNT=0
        JSON_COUNT=0
        TOTAL_LINES=0
        TOTAL_FUNCTIONS=0
        
        # Fun√ß√£o segura para contar fun√ß√µes
        count_functions_safe() {
          local file="$1"
          if [[ "$file" == *.js ]] && [ -f "$file" ] && [ -s "$file" ]; then
            # Usar m√©todo mais seguro
            local funcs=0
            if command -v grep > /dev/null 2>&1; then
              funcs=$(grep -c "function\|=>" "$file" 2>/dev/null || echo "0")
            fi
            echo "$funcs"
          else
            echo "0"
          fi
        }
        
        # Processar arquivos HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            HTML_COUNT=$((HTML_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        # Processar arquivos CSS
        for file in fonte-completo/css/*.css 2>/dev/null; do
          if [ -f "$file" ]; then
            CSS_COUNT=$((CSS_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        # Processar arquivos JS
        for file in fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js 2>/dev/null; do
          if [ -f "$file" ]; then
            JS_COUNT=$((JS_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
            
            # Contar fun√ß√µes
            funcs=$(count_functions_safe "$file")
            TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + funcs))
          fi
        done
        
        # Processar arquivos JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            JSON_COUNT=$((JSON_COUNT + 1))
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            TOTAL_LINES=$((TOTAL_LINES + lines))
          fi
        done
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        # Criar HTML passo a passo
        echo "Criando HTML..."
        
        # Header
        {
          echo '<!DOCTYPE html>'
          echo '<html lang="pt-BR">'
          echo '<head>'
          echo '<meta charset="UTF-8">'
          echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">'
          echo '<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥</title>'
          echo '<style>'
          echo 'body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }'
          echo '.container { max-width: 1400px; margin: 0 auto; }'
          echo 'header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }'
          echo 'h1 { color: #2ea44f; font-size: 2.5em; }'
          echo 'h2 { color: #58a6ff; margin: 30px 0 20px; }'
          echo '.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }'
          echo '.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }'
          echo '.file-card h3 { margin-top: 0; color: #58a6ff; }'
          echo '.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }'
          echo 'pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }'
          echo '.line-number { color: #6a737d; margin-right: 15px; user-select: none; }'
          echo 'a { color: #2ea44f; text-decoration: none; }'
          echo 'a:hover { text-decoration: underline; }'
          echo '.functions-badge { background: #1f6feb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }'
          echo '</style>'
          echo '</head>'
          echo '<body>'
          echo '<div class="container">'
          echo '<header>'
          echo '<h1>üì• C√≥digo Fonte Completo</h1>'
          echo '<p>Im√≥veis Macei√≥ - Extra√ß√£o completa</p>'
          echo '<p><strong>Gerado em:</strong> '"$DATE_NOW"'</p>'
          echo '</header>'
        } > index.html
        
        # Resumo
        {
          echo '<h2>üìä Resumo da Extra√ß√£o</h2>'
          echo '<div style="background: #161b22; padding: 20px; border-radius: 8px; margin: 20px 0;">'
          echo '<p><strong>Total de arquivos:</strong> '"$TOTAL_FILES"'</p>'
          echo '<p><strong>Total de linhas:</strong> '"$TOTAL_LINES"'</p>'
          echo '<p><strong>Fun√ß√µes JavaScript:</strong> '"$TOTAL_FUNCTIONS"'</p>'
          echo '<p><strong>HTML:</strong> '"$HTML_COUNT"' arquivos</p>'
          echo '<p><strong>JavaScript:</strong> '"$JS_COUNT"' arquivos</p>'
          echo '<p><strong>CSS:</strong> '"$CSS_COUNT"' arquivos</p>'
          echo '<p><strong>JSON:</strong> '"$JSON_COUNT"' arquivos</p>'
          echo '</div>'
        } >> index.html
        
        # Lista de arquivos
        {
          echo '<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>'
          echo '<div class="file-list">'
        } >> index.html
        
        # Adicionar arquivos √† lista
        for file in fonte-completo/*.html fonte-completo/css/*.css fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            # Determinar tipo
            if [[ "$file" == *.html ]]; then
              type="HTML"
              icon="üìÑ"
            elif [[ "$file" == *.js ]]; then
              type="JavaScript"
              icon="üìú"
              if [[ "$file" == *"modules"* ]]; then
                type="M√≥dulo JS"
              elif [[ "$file" == *"components"* ]]; then
                type="Componente JS"
              fi
            elif [[ "$file" == *.css ]]; then
              type="CSS"
              icon="üé®"
            elif [[ "$file" == *.json ]]; then
              type="JSON"
              icon="üìã"
            else
              type="Arquivo"
              icon="üìÅ"
            fi
            
            # Contar fun√ß√µes para JS
            functions_display=""
            if [[ "$file" == *.js ]]; then
              funcs=$(count_functions_safe "$file")
              if [ "$funcs" -gt 0 ]; then
                functions_display="<p><strong>Fun√ß√µes:</strong> <span class='functions-badge'>$funcs</span></p>"
              fi
            fi
            
            {
              echo '<div class="file-card">'
              echo "<h3>$icon $filename</h3>"
              echo "<p><strong>Tipo:</strong> $type</p>"
              echo "<p><strong>Linhas:</strong> $lines</p>"
              if [ -n "$functions_display" ]; then
                echo "$functions_display"
              fi
              echo "<p><strong>Tamanho:</strong> ${size_kb} KB</p>"
              echo '</div>'
            } >> index.html
          fi
        done
        
        {
          echo '</div>'
          echo '<h2>üìú C√≥digo Fonte Completo</h2>'
        } >> index.html
        
        # Adicionar c√≥digo completo
        for file in fonte-completo/*.html fonte-completo/css/*.css fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            
            {
              echo '<div class="code-viewer">'
              echo "<h3>$filename ($lines linhas)</h3>"
              echo '<pre>'
            } >> index.html
            
            # Adicionar linhas numeradas
            line_num=1
            while IFS= read -r line || [ -n "$line" ]; do
              # Escapar HTML
              line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              echo "<span class='line-number'>$line_num</span>$line_escaped<br/>" >> index.html
              line_num=$((line_num + 1))
            done < "$file"
            
            {
              echo '</pre>'
              echo '</div>'
            } >> index.html
          fi
        done
        
        # Footer
        {
          echo '<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">'
          echo '<p><strong>üì• Extra√ß√£o Completa do C√≥digo Fonte</strong></p>'
          echo '<p>Todas as linhas foram extra√≠das sem limita√ß√µes</p>'
          echo '</footer>'
          echo '</div>'
          echo '</body>'
          echo '</html>'
        } >> index.html
        
        echo "‚úÖ Relat√≥rio gerado com sucesso!"
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "==============="
        echo "Arquivos: $TOTAL_FILES"
        echo "Linhas: $TOTAL_LINES"
        echo "Fun√ß√µes JS: $TOTAL_FUNCTIONS"
        echo "HTML: $HTML_COUNT"
        echo "JavaScript: $JS_COUNT"
        echo "CSS: $CSS_COUNT"
        echo "JSON: $JSON_COUNT"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO GERADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
