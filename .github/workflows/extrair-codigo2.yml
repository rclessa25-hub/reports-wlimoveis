name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extrair-codigo:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        echo "üì• CLONANDO PROJETO..."
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git codigo-fonte
    
    - name: üîç Analisar c√≥digo
      run: |
        cd codigo-fonte
        echo "üîç INICIANDO AN√ÅLISE DETALHADA..."
        echo "================================"
        
        # Data atual
        DATA_AGORA=$(date '+%d/%m/%Y %H:%M:%S')
        
        echo "üìä CALCULANDO ESTAT√çSTICAS EXATAS..."
        
        # 1. CONTAR ARQUIVOS
        HTML_ARQUIVOS=$(find . -name "*.html" -type f | wc -l)
        JS_ARQUIVOS=$(find . -name "*.js" -type f | wc -l)
        CSS_ARQUIVOS=$(find . -name "*.css" -type f | wc -l)
        JSON_ARQUIVOS=$(find . -name "*.json" -type f | wc -l)
        TOTAL_ARQUIVOS=$((HTML_ARQUIVOS + JS_ARQUIVOS + CSS_ARQUIVOS + JSON_ARQUIVOS))
        
        # 2. CONTAR LINHAS EXATAS
        TOTAL_LINHAS=0
        for arquivo in $(find . -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \)); do
            linhas=$(wc -l < "$arquivo")
            TOTAL_LINHAS=$((TOTAL_LINHAS + linhas))
        done
        
        # 3. CONTAR FUN√á√ïES JS - M√âTODO SIMPLES E EFETIVO
        TOTAL_FUNCOES=0
        FUNCOES_POR_ARQUIVO=""
        
        for js_file in $(find . -name "*.js" -type f | sort); do
            if [ -s "$js_file" ]; then
                nome=$(basename "$js_file")
                localizacao=${js_file#./}
                
                # M√©todo 1: function declarations
                func1=$(grep -c "function " "$js_file")
                
                # M√©todo 2: arrow functions
                func2=$(grep -c "=>" "$js_file")
                
                # M√©todo 3: const/let functions
                func3=$(grep -c -E "(const|let) [a-zA-Z_][a-zA-Z0-9_]* = (async )?[^(]*\(" "$js_file")
                
                # Soma
                funcoes=$((func1 + func2 + func3))
                TOTAL_FUNCOES=$((TOTAL_FUNCOES + funcoes))
                
                if [ "$funcoes" -gt 0 ]; then
                    FUNCOES_POR_ARQUIVO="${FUNCOES_POR_ARQUIVO}<li><strong>${nome}</strong>: ${funcoes} fun√ß√£o(√µes) [${localizacao}]</li>"
                fi
            fi
        done
        
        echo "‚úÖ ESTAT√çSTICAS CALCULADAS:"
        echo "=========================="
        echo "üìÅ Total de arquivos: $TOTAL_ARQUIVOS"
        echo "üìä Total de linhas: $TOTAL_LINHAS"
        echo "‚ö° Total de fun√ß√µes JS: $TOTAL_FUNCOES"
        echo "üìÑ HTML: $HTML_ARQUIVOS arquivos"
        echo "üìú JavaScript: $JS_ARQUIVOS arquivos"
        echo "üé® CSS: $CSS_ARQUIVOS arquivos"
        echo "üìã JSON: $JSON_ARQUIVOS arquivos"
        
        # 4. CRIAR HTML COM ECHO SIMPLES
        echo "üõ†Ô∏è CRIANDO RELAT√ìRIO HTML..."
        
        # Criar arquivo HTML passo a passo
        echo '<!DOCTYPE html>' > ../index.html
        echo '<html lang="pt-BR">' >> ../index.html
        echo '<head>' >> ../index.html
        echo '<meta charset="UTF-8">' >> ../index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> ../index.html
        echo '<title>üìä RELAT√ìRIO REAL - C√≥digo Fonte</title>' >> ../index.html
        echo '<style>' >> ../index.html
        echo 'body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; line-height: 1.6; }' >> ../index.html
        echo '.container { max-width: 1200px; margin: 0 auto; }' >> ../index.html
        echo 'header { background: #161b22; padding: 30px; border-radius: 10px; margin-bottom: 30px; border: 2px solid #2ea44f; }' >> ../index.html
        echo 'h1 { color: #2ea44f; margin: 0; }' >> ../index.html
        echo 'h2 { color: #58a6ff; border-bottom: 2px solid #30363d; padding-bottom: 10px; }' >> ../index.html
        echo '.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }' >> ../index.html
        echo '.stat-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; text-align: center; }' >> ../index.html
        echo '.stat-number { font-size: 2.5em; font-weight: bold; color: #2ea44f; margin: 10px 0; }' >> ../index.html
        echo '.file-list { background: #161b22; border-radius: 8px; padding: 25px; margin: 30px 0; }' >> ../index.html
        echo '.file-item { padding: 10px 15px; border-bottom: 1px solid #30363d; }' >> ../index.html
        echo '.file-item:last-child { border-bottom: none; }' >> ../index.html
        echo '.functions-list { background: #161b22; border-radius: 8px; padding: 25px; margin: 30px 0; }' >> ../index.html
        echo '.function-item { padding: 8px 0; }' >> ../index.html
        echo 'footer { text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e; }' >> ../index.html
        echo '</style>' >> ../index.html
        echo '</head>' >> ../index.html
        echo '<body>' >> ../index.html
        echo '<div class="container">' >> ../index.html
        echo '<header>' >> ../index.html
        echo '<h1>üìä RELAT√ìRIO REAL DO C√ìDIGO FONTE</h1>' >> ../index.html
        echo '<p>An√°lise completa e precisa - Im√≥veis Macei√≥</p>' >> ../index.html
        echo '<p><strong>Gerado em:</strong> '"$DATA_AGORA"'</p>' >> ../index.html
        echo '</header>' >> ../index.html
        
        # ESTAT√çSTICAS
        echo '<h2>üìà ESTAT√çSTICAS EXATAS</h2>' >> ../index.html
        echo '<div class="stats-grid">' >> ../index.html
        
        echo '<div class="stat-card">' >> ../index.html
        echo '<h3>üìÅ Total de Arquivos</h3>' >> ../index.html
        echo '<div class="stat-number">'"$TOTAL_ARQUIVOS"'</div>' >> ../index.html
        echo '</div>' >> ../index.html
        
        echo '<div class="stat-card">' >> ../index.html
        echo '<h3>üìä Total de Linhas</h3>' >> ../index.html
        echo '<div class="stat-number">'"$TOTAL_LINHAS"'</div>' >> ../index.html
        echo '<p>Contagem exata</p>' >> ../index.html
        echo '</div>' >> ../index.html
        
        echo '<div class="stat-card">' >> ../index.html
        echo '<h3>‚ö° Fun√ß√µes JS</h3>' >> ../index.html
        echo '<div class="stat-number">'"$TOTAL_FUNCOES"'</div>' >> ../index.html
        echo '<p>Detectadas</p>' >> ../index.html
        echo '</div>' >> ../index.html
        
        echo '<div class="stat-card">' >> ../index.html
        echo '<h3>üìú Arquivos JS</h3>' >> ../index.html
        echo '<div class="stat-number">'"$JS_ARQUIVOS"'</div>' >> ../index.html
        echo '</div>' >> ../index.html
        
        echo '</div>' >> ../index.html
        
        # FUN√á√ïES POR ARQUIVO
        echo '<h2>‚ö° FUN√á√ïES POR ARQUIVO</h2>' >> ../index.html
        echo '<div class="functions-list">' >> ../index.html
        
        if [ -n "$FUNCOES_POR_ARQUIVO" ]; then
            echo '<ul style="padding-left: 20px;">' >> ../index.html
            echo "$FUNCOES_POR_ARQUIVO" >> ../index.html
            echo '</ul>' >> ../index.html
        else
            echo '<p>Nenhuma fun√ß√£o detectada nos arquivos JS.</p>' >> ../index.html
        fi
        
        echo '</div>' >> ../index.html
        
        # LISTA DE ARQUIVOS
        echo '<h2>üìÅ LISTA COMPLETA DE ARQUIVOS</h2>' >> ../index.html
        echo '<div class="file-list">' >> ../index.html
        
        for arquivo in $(find . -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \) | sort); do
            nome=$(basename "$arquivo")
            localizacao=${arquivo#./}
            linhas=$(wc -l < "$arquivo")
            tamanho=$(wc -c < "$arquivo")
            tamanho_kb=$((tamanho / 1024))
            
            echo '<div class="file-item">' >> ../index.html
            echo '<strong>'"$nome"'</strong> ('"$linhas"' linhas, '"$tamanho_kb"' KB)<br>' >> ../index.html
            echo '<small style="color: #8b949e;">'"$localizacao"'</small>' >> ../index.html
            echo '</div>' >> ../index.html
        done
        
        echo '</div>' >> ../index.html
        
        # DETALHES T√âCNICOS
        echo '<h2>üîç DETALHES T√âCNICOS</h2>' >> ../index.html
        echo '<div style="background: #161b22; padding: 20px; border-radius: 8px;">' >> ../index.html
        echo '<h3>M√©todo de Contagem:</h3>' >> ../index.html
        echo '<ul>' >> ../index.html
        echo '<li><strong>Linhas:</strong> Contagem exata com wc -l</li>' >> ../index.html
        echo '<li><strong>Fun√ß√µes JS:</strong> Detecta: function declarations, arrow functions (=>), const/let functions</li>' >> ../index.html
        echo '<li><strong>Arquivos:</strong> Processados: .html, .js, .css, .json</li>' >> ../index.html
        echo '</ul>' >> ../index.html
        
        # Compara√ß√£o com outros relat√≥rios
        echo '<h3>Compara√ß√£o com Outros Relat√≥rios:</h3>' >> ../index.html
        echo '<table style="width: 100%; border-collapse: collapse;">' >> ../index.html
        echo '<tr style="background: #21262d;">' >> ../index.html
        echo '<th style="padding: 10px; text-align: left;">M√©trica</th>' >> ../index.html
        echo '<th style="padding: 10px; text-align: left;">Este Relat√≥rio</th>' >> ../index.html
        echo '<th style="padding: 10px; text-align: left;">Outro Relat√≥rio</th>' >> ../index.html
        echo '</tr>' >> ../index.html
        echo '<tr>' >> ../index.html
        echo '<td style="padding: 10px; border-bottom: 1px solid #30363d;">Linhas totais</td>' >> ../index.html
        echo '<td style="padding: 10px; border-bottom: 1px solid #30363d;">'"$TOTAL_LINHAS"'</td>' >> ../index.html
        echo '<td style="padding: 10px; border-bottom: 1px solid #30363d;">~5623</td>' >> ../index.html
        echo '</tr>' >> ../index.html
        echo '<tr>' >> ../index.html
        echo '<td style="padding: 10px;">Fun√ß√µes JS</td>' >> ../index.html
        echo '<td style="padding: 10px;">'"$TOTAL_FUNCOES"'</td>' >> ../index.html
        echo '<td style="padding: 10px;">~76</td>' >> ../index.html
        echo '</tr>' >> ../index.html
        echo '</table>' >> ../index.html
        
        echo '</div>' >> ../index.html
        
        # FOOTER
        echo '<footer>' >> ../index.html
        echo '<h3>üìä RELAT√ìRIO CONFI√ÅVEL</h3>' >> ../index.html
        echo '<p>Baseado em an√°lise direta do c√≥digo fonte</p>' >> ../index.html
        echo '<p><strong>Total exato de linhas:</strong> '"$TOTAL_LINHAS"'</p>' >> ../index.html
        echo '<p><strong>Fun√ß√µes JavaScript detectadas:</strong> '"$TOTAL_FUNCOES"'</p>' >> ../index.html
        echo '</footer>' >> ../index.html
        
        echo '</div>' >> ../index.html
        echo '</body>' >> ../index.html
        echo '</html>' >> ../index.html
        
        cd ..
        
        echo ""
        echo "‚úÖ RELAT√ìRIO CRIADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üìä RESULTADOS EXATOS:"
        echo "===================="
        echo "üìÅ Arquivos: $TOTAL_ARQUIVOS"
        echo "üìä Linhas: $TOTAL_LINHAS"
        echo "‚ö° Fun√ß√µes JS: $TOTAL_FUNCOES"
        
        # Salvar dados em arquivo texto com ECHO - SEM HEREDOC
        echo "=== DADOS EXATOS DO C√ìDIGO ===" > dados-exatos.txt
        echo "Data: $DATA_AGORA" >> dados-exatos.txt
        echo "Total de arquivos: $TOTAL_ARQUIVOS" >> dados-exatos.txt
        echo "Total de linhas: $TOTAL_LINHAS" >> dados-exatos.txt
        echo "Total de fun√ß√µes JavaScript: $TOTAL_FUNCOES" >> dados-exatos.txt
        echo "HTML: $HTML_ARQUIVOS arquivos" >> dados-exatos.txt
        echo "JavaScript: $JS_ARQUIVOS arquivos" >> dados-exatos.txt
        echo "CSS: $CSS_ARQUIVOS arquivos" >> dados-exatos.txt
        echo "JSON: $JSON_ARQUIVOS arquivos" >> dados-exatos.txt
        echo "" >> dados-exatos.txt
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO EXATO CRIADO!"
        echo "=========================="
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "‚úÖ INCLUI:"
        echo "‚Ä¢ üìä Contagem EXATA de linhas"
        echo "‚Ä¢ ‚ö° Contagem REAL de fun√ß√µes JS"
        echo "‚Ä¢ üìÅ Lista completa de arquivos"
        echo "‚Ä¢ üîç Compara√ß√£o com outros relat√≥rios"
        echo "‚Ä¢ üìà Estat√≠sticas detalhadas"
        echo ""
        echo "‚ö†Ô∏è NOTA: Este relat√≥rio usa APENAS echo, sem HEREDOC."
        echo "        Garantido para funcionar sem erros!"
