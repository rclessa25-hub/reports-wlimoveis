name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
    
    - name: üìù Criar relat√≥rio simples e funcional
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO SIMPLES..."
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        echo "Analisando arquivos..."
        
        # Criar arquivo HTML com echo simples
        echo '<!DOCTYPE html>' > index.html
        echo '<html lang="pt-BR">' >> index.html
        echo '<head>' >> index.html
        echo '<meta charset="UTF-8">' >> index.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> index.html
        echo '<title>üìä Relat√≥rio de C√≥digo</title>' >> index.html
        echo '<style>' >> index.html
        echo 'body { font-family: Arial, sans-serif; background: #f5f5f5; color: #333; margin: 0; padding: 20px; }' >> index.html
        echo '.container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }' >> index.html
        echo 'h1 { color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }' >> index.html
        echo 'h2 { color: #2980b9; margin-top: 30px; }' >> index.html
        echo '.file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }' >> index.html
        echo '.file-card { background: #f8f9fa; border: 1px solid #ddd; border-radius: 8px; padding: 15px; }' >> index.html
        echo '.file-card h3 { margin-top: 0; color: #2c3e50; }' >> index.html
        echo '.warning { background: #fff3cd; border: 1px solid #ffc107; color: #856404; padding: 10px; border-radius: 5px; margin: 10px 0; }' >> index.html
        echo '.code-box { background: #2c3e50; color: #ecf0f1; padding: 15px; border-radius: 5px; margin: 15px 0; font-family: monospace; font-size: 14px; overflow-x: auto; }' >> index.html
        echo '.line-num { color: #7f8c8d; margin-right: 10px; }' >> index.html
        echo '</style>' >> index.html
        echo '</head>' >> index.html
        echo '<body>' >> index.html
        echo '<div class="container">' >> index.html
        echo '<h1>üìä Relat√≥rio de C√≥digo Fonte</h1>' >> index.html
        echo '<p><strong>Data:</strong> '"$DATE_NOW"'</p>' >> index.html
        echo '<p><strong>Projeto:</strong> Im√≥veis Macei√≥</p>' >> index.html
        
        # Adicionar alerta sobre inconsist√™ncias
        echo '<div class="warning">' >> index.html
        echo '<strong>‚ö†Ô∏è ALERTA:</strong> Inconsist√™ncias detectadas entre relat√≥rios.' >> index.html
        echo '</div>' >> index.html
        
        # Listar arquivos JavaScript
        echo '<h2>üìú Arquivos JavaScript</h2>' >> index.html
        echo '<div class="file-grid">' >> index.html
        
        # Processar arquivos JS
        JS_FILES=$(find fonte-completo -name "*.js" -type f | sort)
        for file in $JS_FILES; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            location=${file#fonte-completo/}
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            
            # Determinar tipo
            if [[ "$location" == *"modules"* ]]; then
              tipo="(M√≥dulo)"
            elif [[ "$location" == *"components"* ]]; then
              tipo="(Componente)"
            else
              tipo=""
            fi
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>'"$filename $tipo"'</h3>' >> index.html
            echo '<p><strong>Local:</strong> '"$(dirname "$location")"'</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            
            # Mostrar conte√∫do se for pequeno
            if [ "$lines" -le 5 ]; then
              echo '<p><strong>Conte√∫do:</strong></p>' >> index.html
              echo '<div style="background: #e9ecef; padding: 5px; border-radius: 3px; font-family: monospace; font-size: 12px;">' >> index.html
              cat "$file" | sed 's/</\&lt;/g; s/>/\&gt;/g' >> index.html
              echo '</div>' >> index.html
            fi
            
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        # Listar outros arquivos
        echo '<h2>üìÑ Outros Arquivos</h2>' >> index.html
        echo '<div class="file-grid">' >> index.html
        
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>'"$filename"'</h3>' >> index.html
            echo '<p><strong>Tipo:</strong> HTML</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file")
              size=$(wc -c < "$file")
              size_kb=$((size / 1024))
              
              echo '<div class="file-card">' >> index.html
              echo '<h3>'"$filename"'</h3>' >> index.html
              echo '<p><strong>Tipo:</strong> CSS</p>' >> index.html
              echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
              echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
              echo '</div>' >> index.html
            fi
          done
        fi
        
        # JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            
            echo '<div class="file-card">' >> index.html
            echo '<h3>'"$filename"'</h3>' >> index.html
            echo '<p><strong>Tipo:</strong> JSON</p>' >> index.html
            echo '<p><strong>Linhas:</strong> '"$lines"'</p>' >> index.html
            echo '<p><strong>Tamanho:</strong> '"$size_kb"' KB</p>' >> index.html
            echo '</div>' >> index.html
          fi
        done
        
        echo '</div>' >> index.html
        
        # Mostrar an√°lise
        echo '<h2>üîç An√°lise</h2>' >> index.html
        echo '<div style="background: #e8f4f8; padding: 15px; border-radius: 8px;">' >> index.html
        echo '<h3>üìã Resumo dos Dados:</h3>' >> index.html
        
        # Contar estat√≠sticas
        HTML_COUNT=$(find fonte-completo -name "*.html" -type f | wc -l)
        JS_COUNT=$(echo "$JS_FILES" | wc -l)
        CSS_COUNT=$(find fonte-completo -name "*.css" -type f | wc -l)
        JSON_COUNT=$(find fonte-completo -name "*.json" -type f | wc -l)
        
        echo '<p><strong>Total de arquivos:</strong> '"$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))"'</p>' >> index.html
        echo '<p><strong>HTML:</strong> '"$HTML_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>JavaScript:</strong> '"$JS_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>CSS:</strong> '"$CSS_COUNT"' arquivos</p>' >> index.html
        echo '<p><strong>JSON:</strong> '"$JSON_COUNT"' arquivos</p>' >> index.html
        
        # Analisar arquivos JS com 1 linha
        JS_ONE_LINE=0
        for file in $JS_FILES; do
          lines=$(wc -l < "$file")
          if [ "$lines" -eq 1 ]; then
            JS_ONE_LINE=$((JS_ONE_LINE + 1))
          fi
        done
        
        echo '<p><strong>Arquivos JS com 1 linha:</strong> '"$JS_ONE_LINE"'</p>' >> index.html
        
        if [ "$JS_ONE_LINE" -gt 0 ]; then
          echo '<div class="warning">' >> index.html
          echo '<p><strong>‚ö†Ô∏è OBSERVA√á√ÉO:</strong> '"$JS_ONE_LINE"' arquivos JavaScript t√™m apenas 1 linha.</p>' >> index.html
          echo '<p>Isso pode indicar:</p>' >> index.html
          echo '<ul>' >> index.html
          echo '<li>Arquivos minificados/incompletos</li>' >> index.html
          echo '<li>Vers√µes diferentes das analisadas em outros relat√≥rios</li>' >> index.html
          echo '<li>Conte√∫do em outros branches ou locais</li>' >> index.html
          echo '</ul>' >> index.html
          echo '</div>' >> index.html
        fi
        
        echo '</div>' >> index.html
        
        # Mostrar c√≥digo de exemplo
        echo '<h2>üìù Exemplo de C√≥digo</h2>' >> index.html
        echo '<p>Abaixo est√£o os primeiros 50 linhas do index.html:</p>' >> index.html
        
        if [ -f "fonte-completo/index.html" ]; then
          echo '<div class="code-box">' >> index.html
          line_num=1
          head -50 fonte-completo/index.html | while IFS= read -r line; do
            line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            echo '<span class="line-num">'"$line_num"'</span> '"$line_escaped"'<br/>' >> index.html
            line_num=$((line_num + 1))
          done
          echo '</div>' >> index.html
        fi
        
        # Footer
        echo '<footer style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #ddd; text-align: center; color: #7f8c8d;">' >> index.html
        echo '<p><strong>üìä Relat√≥rio de C√≥digo Fonte</strong></p>' >> index.html
        echo '<p>Gerado automaticamente</p>' >> index.html
        echo '</footer>' >> index.html
        echo '</div>' >> index.html
        echo '</body>' >> index.html
        echo '</html>' >> index.html
        
        echo "‚úÖ Relat√≥rio criado com sucesso!"
        echo ""
        echo "üìã RESUMO:"
        echo "========="
        echo "Arquivos HTML: $HTML_COUNT"
        echo "Arquivos JavaScript: $JS_COUNT"
        echo "Arquivos CSS: $CSS_COUNT"
        echo "Arquivos JSON: $JSON_COUNT"
        echo "Arquivos JS com 1 linha: $JS_ONE_LINE"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO CRIADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "‚úÖ CARACTER√çSTICAS:"
        echo "‚Ä¢ ‚úÖ 100% funcional (sem HEREDOC)"
        echo "‚Ä¢ üìä Estat√≠sticas reais"
        echo "‚Ä¢ üîç An√°lise de inconsist√™ncias"
        echo "‚Ä¢ üìù Exemplo de c√≥digo"
        echo "‚Ä¢ üé® Design limpo e profissional"
