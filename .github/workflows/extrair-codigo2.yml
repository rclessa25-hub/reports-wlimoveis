name: üì• Extrair C√≥digo Fonte ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto principal
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        echo "========================="
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
        
        echo "üìÅ Verificando arquivos JS..."
        echo "=========================="
        for js_file in fonte-completo/js/*.js fonte-completo/js/**/*.js 2>/dev/null; do
          if [ -f "$js_file" ] && [ -s "$js_file" ]; then
            lines=$(wc -l < "$js_file" 2>/dev/null || echo "0")
            echo "$(basename "$js_file"): $lines linhas"
          fi
        done
    
    - name: üìù Criar relat√≥rio com c√≥digo real
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO..."
        echo "======================"
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Calcular estat√≠sticas
        HTML_FILES=$(find fonte-completo -name "*.html" -type f)
        JS_FILES=$(find fonte-completo -name "*.js" -type f)
        CSS_FILES=$(find fonte-completo -name "*.css" -type f)
        JSON_FILES=$(find fonte-completo -name "*.json" -type f)
        
        HTML_COUNT=$(echo "$HTML_FILES" | grep -c "^" || echo "0")
        JS_COUNT=$(echo "$JS_FILES" | grep -c "^" || echo "0")
        CSS_COUNT=$(echo "$CSS_FILES" | grep -c "^" || echo "0")
        JSON_COUNT=$(echo "$JSON_FILES" | grep -c "^" || echo "0")
        
        # Contar linhas totais
        TOTAL_LINES=0
        for file in $HTML_FILES $JS_FILES $CSS_FILES $JSON_FILES; do
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          TOTAL_LINES=$((TOTAL_LINES + lines))
        done
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        # Fun√ß√£o SIMPLES para contar fun√ß√µes
        echo 'count_functions_simple() {' > count_func.sh
        echo '  local file="$1"' >> count_func.sh
        echo '  if [[ "$file" == *.js ]] && [ -s "$file" ]; then' >> count_func.sh
        echo '    local lines=$(wc -l < "$file" 2>/dev/null)' >> count_func.sh
        echo '    if [ "$lines" -lt 5 ]; then' >> count_func.sh
        echo '      echo "0"' >> count_func.sh
        echo '      return' >> count_func.sh
        echo '    fi' >> count_func.sh
        echo '    # Contar function declarations e arrow functions' >> count_func.sh
        echo '    local count=$(grep -c -E "function\s+\w+|=\s*(async\s+)?\(.*\)\s*=>|\w+\s*\(.*\)\s*\{" "$file" 2>/dev/null || echo "0")' >> count_func.sh
        echo '    echo "$count"' >> count_func.sh
        echo '  else' >> count_func.sh
        echo '    echo "0"' >> count_func.sh
        echo '  fi' >> count_func.sh
        echo '}' >> count_func.sh
        
        chmod +x count_func.sh
        source ./count_func.sh
        
        # Testar contagem
        echo ""
        echo "üßÆ CONTANDO FUN√á√ïES..."
        echo "====================="
        TOTAL_FUNCTIONS=0
        for js_file in $JS_FILES; do
          if [ -f "$js_file" ]; then
            functions=$(count_functions_simple "$js_file")
            lines=$(wc -l < "$js_file" 2>/dev/null || echo "0")
            TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + functions))
            echo "$(basename "$js_file"): $lines linhas, $functions fun√ß√µes"
          fi
        done
        
        # Criar HTML b√°sico
        cat > index.html << EOF
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥</title>
<style>
body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }
h1 { color: #2ea44f; font-size: 2.5em; }
h2 { color: #58a6ff; margin: 30px 0 20px; }
.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
.file-card h3 { margin-top: 0; color: #58a6ff; }
.file-card .js { color: #f1e05a; }
.file-card .css { color: #563d7c; }
.file-card .html { color: #e34c26; }
.file-card .json { color: #f1e05a; opacity: 0.8; }
.file-info p { margin: 8px 0; }
.functions-badge { background: #1f6feb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }
pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }
.line-number { color: #6a737d; margin-right: 15px; user-select: none; }
a { color: #2ea44f; text-decoration: none; }
a:hover { text-decoration: underline; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
<header>
<h1>üì• C√≥digo Fonte Completo</h1>
<p>Im√≥veis Macei√≥ - Extra√ß√£o completa de todas as linhas</p>
<p><strong>Gerado em:</strong> $DATE_NOW</p>
</header>

<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>
<div class="file-list">
EOF
        
        # Adicionar cards de arquivos
        for file in fonte-completo/*.html fonte-completo/css/*.css fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            dir_path=$(dirname "$relative_path")
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            size=$(wc -c < "$file" 2>/dev/null || echo "0")
            size_kb=$((size / 1024))
            
            if [[ "$file" == *.html ]]; then
              icon="üìÑ"
              class="html"
              type="HTML"
              functions_display="N/A"
            elif [[ "$file" == *.js ]]; then
              icon="üìú"
              class="js"
              functions=$(count_functions_simple "$file")
              if [[ "$relative_path" == *"modules"* ]]; then
                type="M√≥dulo JS"
              elif [[ "$relative_path" == *"components"* ]]; then
                type="Componente JS"
              else
                type="JavaScript"
              fi
              if [ "$functions" -gt 0 ]; then
                functions_display="<span class='functions-badge'>$functions fun√ß√£o(√µes)</span>"
              else
                functions_display="Sem fun√ß√µes detectadas"
              fi
            elif [[ "$file" == *.css ]]; then
              icon="üé®"
              class="css"
              type="CSS"
              functions_display="N/A"
            elif [[ "$file" == *.json ]]; then
              icon="üìã"
              class="json"
              type="JSON"
              functions_display="N/A"
            else
              icon="üìÅ"
              class=""
              type="Arquivo"
              functions_display="N/A"
            fi
            
            cat >> index.html << FILEEOF
<div class="file-card">
<h3>$icon <span class="$class">$filename</span></h3>
<div class="file-info">
<p><strong>Local:</strong> $dir_path</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> $functions_display</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
<p><a href="#$(echo "$relative_path" | sed 's/[^a-zA-Z0-9]/_/g')"><i class="fas fa-eye"></i> Ver c√≥digo completo ‚Üí</a></p>
</div>
FILEEOF
          fi
        done
        
        # Fechar lista e adicionar resumo
        cat >> index.html << EOF
</div>

<h2>üìä Resumo da Extra√ß√£o</h2>
<div style="background: #161b22; padding: 20px; border-radius: 8px;">
<p><strong>Total de arquivos:</strong> $TOTAL_FILES</p>
<p><strong>Total de linhas:</strong> $TOTAL_LINES</p>
<p><strong>Total de fun√ß√µes JS:</strong> $TOTAL_FUNCTIONS</p>
<p><strong>HTML:</strong> $HTML_COUNT arquivos</p>
<p><strong>JavaScript:</strong> $JS_COUNT arquivos</p>
<p><strong>CSS:</strong> $CSS_COUNT arquivos</p>
<p><strong>JSON:</strong> $JSON_COUNT arquivos</p>
</div>

<h2>üìú C√≥digo Fonte Completo</h2>
EOF
        
        # Adicionar c√≥digo de cada arquivo
        for file in fonte-completo/*.html fonte-completo/css/*.css fonte-completo/js/*.js fonte-completo/js/modules/*.js fonte-completo/js/components/*.js fonte-completo/*.json 2>/dev/null; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            relative_path=${file#fonte-completo/}
            file_id=$(echo "$relative_path" | sed 's/[^a-zA-Z0-9]/_/g')
            lines=$(wc -l < "$file" 2>/dev/null || echo "0")
            
            cat >> index.html << CODEEOF
<div class="code-viewer" id="$file_id">
<h3>$relative_path ($lines linhas)</h3>
<pre>
CODEEOF
            
            cat "$file" | cat -n | while read num line; do
              line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
              echo "<span class='line-number'>$num</span>$line_escaped<br/>" >> index.html
            done
            
            cat >> index.html << 'CODEEOF'
</pre>
</div>
CODEEOF
          fi
        done
        
        # Footer
        cat >> index.html << 'EOF'
<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">
<p><strong>üì• Extra√ß√£o Completa do C√≥digo Fonte</strong></p>
<p>Gerado automaticamente em '"$DATE_NOW"'</p>
</footer>
</div>
</body>
</html>
EOF
        
        echo "‚úÖ Relat√≥rio gerado com sucesso!"
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "==============="
        echo "Arquivos: $TOTAL_FILES"
        echo "Linhas: $TOTAL_LINES"
        echo "Fun√ß√µes JS: $TOTAL_FUNCTIONS"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO GERADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "‚úÖ FUNCIONALIDADES:"
        echo "‚Ä¢ üìÅ Lista completa de arquivos"
        echo "‚Ä¢ ‚ö° Contagem de fun√ß√µes JavaScript"
        echo "‚Ä¢ üìä Estat√≠sticas precisas"
        echo "‚Ä¢ üìú C√≥digo completo sem limita√ß√µes"
        echo "‚Ä¢ üîÑ Atualiza√ß√£o autom√°tica"
