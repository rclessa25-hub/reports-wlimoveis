name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto principal
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        echo "========================="
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
    
    - name: üìù Criar relat√≥rio com c√≥digo real
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO..."
        echo "======================"
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # Calcular estat√≠sticas
        HTML_COUNT=$(find fonte-completo -name "*.html" -type f | wc -l)
        JS_COUNT=$(find fonte-completo -name "*.js" -type f | wc -l)
        CSS_COUNT=$(find fonte-completo -name "*.css" -type f | wc -l)
        JSON_COUNT=$(find fonte-completo -name "*.json" -type f | wc -l)
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        # Contar linhas totais
        TOTAL_LINES=0
        for file in $(find fonte-completo -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \)); do
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          TOTAL_LINES=$((TOTAL_LINES + lines))
        done
        
        # Criar fun√ß√£o para contar fun√ß√µes
        cat > /tmp/count_func.sh << 'FUNC_EOF'
count_functions() {
  local file="$1"
  if [[ "$file" == *.js ]] && [ -s "$file" ]; then
    local lines=$(wc -l < "$file" 2>/dev/null)
    if [ "$lines" -lt 5 ]; then
      echo "0"
      return
    fi
    local count=$(grep -c -E "function[[:space:]]+[a-zA-Z_][a-zA-Z0-9_]*|=[[:space:]]*(async[[:space:]]+)?\(.*\)[[:space:]]*=>|[a-zA-Z_][a-zA-Z0-9_]*[[:space:]]*\(.*\)[[:space:]]*\{" "$file" 2>/dev/null || echo "0")
    echo "$count"
  else
    echo "0"
  fi
}
FUNC_EOF
        
        source /tmp/count_func.sh
        
        # Contar fun√ß√µes totais
        TOTAL_FUNCTIONS=0
        for js_file in $(find fonte-completo -name "*.js" -type f); do
          functions=$(count_functions "$js_file")
          TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + functions))
        done
        
        # Criar o HTML em partes
        echo 'Criando HTML...'
        
        # Parte 1: Header
        cat > /tmp/header.html << 'HEADER_EOF'
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥</title>
<style>
body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }
h1 { color: #2ea44f; font-size: 2.5em; }
h2 { color: #58a6ff; margin: 30px 0 20px; }
.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
.file-card h3 { margin-top: 0; color: #58a6ff; }
.file-card .js { color: #f1e05a; }
.file-card .css { color: #563d7c; }
.file-card .html { color: #e34c26; }
.file-card .json { color: #f1e05a; opacity: 0.8; }
.file-info p { margin: 8px 0; }
.functions-badge { background: #1f6feb; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85em; }
.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }
pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }
.line-number { color: #6a737d; margin-right: 15px; user-select: none; }
a { color: #2ea44f; text-decoration: none; }
a:hover { text-decoration: underline; }
.summary { background: #161b22; padding: 20px; border-radius: 8px; margin: 30px 0; }
.summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }
.summary-item { text-align: center; padding: 15px; background: #21262d; border-radius: 6px; }
.summary-number { font-size: 2em; font-weight: bold; color: #2ea44f; margin: 10px 0; }
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
<div class="container">
<header>
<h1>üì• C√≥digo Fonte Completo</h1>
<p>Im√≥veis Macei√≥ - Extra√ß√£o completa de todas as linhas</p>
<p><strong>Gerado em:</strong> 
HEADER_EOF
        
        echo "$DATE_NOW" >> /tmp/header.html
        
        cat >> /tmp/header.html << 'HEADER_EOF2'
</p>
</header>
HEADER_EOF2
        
        # Criar arquivos em partes e concatenar
        cat /tmp/header.html > index.html
        
        # Adicionar lista de arquivos
        cat >> index.html << 'LIST_START'
<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>
<div class="file-list">
LIST_START
        
        # Adicionar cada arquivo
        for file in $(find fonte-completo -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \) | sort); do
          filename=$(basename "$file")
          relative_path=${file#fonte-completo/}
          dir_path=$(dirname "$relative_path")
          if [ "$dir_path" = "." ]; then
            dir_path="raiz"
          fi
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          size=$(wc -c < "$file" 2>/dev/null || echo "0")
          size_kb=$((size / 1024))
          
          if [[ "$file" == *.html ]]; then
            icon="üìÑ"
            class="html"
            type="HTML"
            functions_display="N/A"
          elif [[ "$file" == *.js ]]; then
            icon="üìú"
            class="js"
            functions=$(count_functions "$file")
            if [[ "$relative_path" == *"modules"* ]]; then
              type="M√≥dulo JS"
            elif [[ "$relative_path" == *"components"* ]]; then
              type="Componente JS"
            else
              type="JavaScript"
            fi
            if [ "$functions" -gt 0 ]; then
              functions_display="<span class='functions-badge'>$functions fun√ß√£o(√µes)</span>"
            else
              functions_display="Sem fun√ß√µes detectadas"
            fi
          elif [[ "$file" == *.css ]]; then
            icon="üé®"
            class="css"
            type="CSS"
            functions_display="N/A"
          elif [[ "$file" == *.json ]]; then
            icon="üìã"
            class="json"
            type="JSON"
            functions_display="N/A"
          else
            icon="üìÅ"
            class=""
            type="Arquivo"
            functions_display="N/A"
          fi
          
          cat >> index.html << FILE_CARD
<div class="file-card">
<h3>$icon <span class="$class">$filename</span></h3>
<div class="file-info">
<p><strong>Local:</strong> $dir_path</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> $functions_display</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
<p><a href="#$(echo "$relative_path" | sed 's/[^a-zA-Z0-9]/_/g')"><i class="fas fa-eye"></i> Ver c√≥digo completo ‚Üí</a></p>
</div>
FILE_CARD
        done
        
        cat >> index.html << 'LIST_END'
</div>
LIST_END
        
        # Adicionar resumo
        cat >> index.html << SUMMARY_START
<h2>üìä Resumo da Extra√ß√£o</h2>
<div class="summary">
<div class="summary-grid">
<div class="summary-item">
<h4>Total de Arquivos</h4>
<div class="summary-number">$TOTAL_FILES</div>
</div>
<div class="summary-item">
<h4>Total de Linhas</h4>
<div class="summary-number">$TOTAL_LINES</div>
</div>
<div class="summary-item">
<h4>Fun√ß√µes JS</h4>
<div class="summary-number">$TOTAL_FUNCTIONS</div>
</div>
<div class="summary-item">
<h4>HTML</h4>
<div class="summary-number">$HTML_COUNT</div>
</div>
<div class="summary-item">
<h4>JavaScript</h4>
<div class="summary-number">$JS_COUNT</div>
</div>
<div class="summary-item">
<h4>CSS</h4>
<div class="summary-number">$CSS_COUNT</div>
</div>
<div class="summary-item">
<h4>JSON</h4>
<div class="summary-number">$JSON_COUNT</div>
</div>
</div>
</div>

<h2>üìú C√≥digo Fonte Completo</h2>
SUMMARY_START
        
        # Adicionar c√≥digo de cada arquivo
        for file in $(find fonte-completo -type f \( -name "*.html" -o -name "*.js" -o -name "*.css" -o -name "*.json" \) | sort); do
          filename=$(basename "$file")
          relative_path=${file#fonte-completo/}
          file_id=$(echo "$relative_path" | sed 's/[^a-zA-Z0-9]/_/g')
          lines=$(wc -l < "$file" 2>/dev/null || echo "0")
          
          cat >> index.html << CODE_START
<div class="code-viewer" id="$file_id">
<h3>$relative_path ($lines linhas)</h3>
<pre>
CODE_START
          
          line_num=1
          while IFS= read -r line || [ -n "$line" ]; do
            line_escaped=$(echo "$line" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g')
            echo "<span class='line-number'>$line_num</span>$line_escaped<br/>" >> index.html
            line_num=$((line_num + 1))
          done < "$file"
          
          cat >> index.html << CODE_END
</pre>
</div>
CODE_END
        done
        
        # Footer
        cat >> index.html << 'FOOTER_EOF'
<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">
<p><strong>üì• Extra√ß√£o Completa do C√≥digo Fonte</strong></p>
<p>Gerado automaticamente</p>
</footer>
</div>
<script>
document.querySelectorAll('.code-viewer pre').forEach(pre => {
    const keywords = ['function', 'const', 'let', 'var', 'class', 'import', 'export', 'async', 'await', 'return', 'if', 'else', 'for', 'while', 'try', 'catch', 'throw'];
    let html = pre.innerHTML;
    keywords.forEach(keyword => {
        const regex = new RegExp('\\b' + keyword + '\\b', 'g');
        html = html.replace(regex, '<span style="color: #ff7b72; font-weight: bold;">' + keyword + '</span>');
    });
    html = html.replace(/(\w+)\s*\(/g, '<span style="color: #d2a8ff;">$1</span>(');
    pre.innerHTML = html;
});
</script>
</body>
</html>
FOOTER_EOF
        
        echo "‚úÖ Relat√≥rio gerado com sucesso!"
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "==============="
        echo "Arquivos: $TOTAL_FILES"
        echo "Linhas: $TOTAL_LINES"
        echo "Fun√ß√µes JS: $TOTAL_FUNCTIONS"
        echo "HTML: $HTML_COUNT"
        echo "JavaScript: $JS_COUNT"
        echo "CSS: $CSS_COUNT"
        echo "JSON: $JSON_COUNT"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO GERADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "‚úÖ FUNCIONALIDADES:"
        echo "‚Ä¢ üìÅ Lista completa de arquivos"
        echo "‚Ä¢ ‚ö° Contagem de fun√ß√µes JavaScript"
        echo "‚Ä¢ üìä Estat√≠sticas precisas"
        echo "‚Ä¢ üìú C√≥digo completo sem limita√ß√µes"
        echo "‚Ä¢ üé® Design moderno e responsivo"
