name: üì• Extrair C√≥digo Fonte Ver2

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  extract-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto
      run: |
        echo "üì• CLONANDO C√ìDIGO FONTE..."
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git fonte-completo
    
    - name: üìù Criar relat√≥rio ultra-simples
      run: |
        echo "üìÑ GERANDO RELAT√ìRIO ULTRA-SIMPLES..."
        
        DATE_NOW=$(date '+%d/%m/%Y √†s %H:%M:%S')
        
        # M√©todo SIMPLES para contar - sem redirecionamentos
        echo "Calculando estat√≠sticas..."
        
        # Inicializar contadores
        HTML_COUNT=0
        JS_COUNT=0
        CSS_COUNT=0
        JSON_COUNT=0
        TOTAL_LINES=0
        TOTAL_FUNCTIONS=0
        
        # Processar cada tipo separadamente
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            HTML_COUNT=$((HTML_COUNT + 1))
            L=$(wc -l < "$file")
            TOTAL_LINES=$((TOTAL_LINES + L))
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              CSS_COUNT=$((CSS_COUNT + 1))
              L=$(wc -l < "$file")
              TOTAL_LINES=$((TOTAL_LINES + L))
            fi
          done
        fi
        
        # JavaScript
        # JS na raiz
        for file in fonte-completo/js/*.js; do
          if [ -f "$file" ]; then
            JS_COUNT=$((JS_COUNT + 1))
            L=$(wc -l < "$file")
            TOTAL_LINES=$((TOTAL_LINES + L))
            # Contar fun√ß√µes de forma SIMPLES
            if grep -q "function" "$file"; then
              F=$(grep -c "function" "$file")
              TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
            fi
          fi
        done
        
        # M√≥dulos JS
        if [ -d "fonte-completo/js/modules" ]; then
          for file in fonte-completo/js/modules/*.js; do
            if [ -f "$file" ]; then
              JS_COUNT=$((JS_COUNT + 1))
              L=$(wc -l < "$file")
              TOTAL_LINES=$((TOTAL_LINES + L))
              if grep -q "function" "$file"; then
                F=$(grep -c "function" "$file")
                TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
              fi
            fi
          done
        fi
        
        # Componentes JS
        if [ -d "fonte-completo/js/components" ]; then
          for file in fonte-completo/js/components/*.js; do
            if [ -f "$file" ]; then
              JS_COUNT=$((JS_COUNT + 1))
              L=$(wc -l < "$file")
              TOTAL_LINES=$((TOTAL_LINES + L))
              if grep -q "function" "$file"; then
                F=$(grep -c "function" "$file")
                TOTAL_FUNCTIONS=$((TOTAL_FUNCTIONS + F))
              fi
            fi
          done
        fi
        
        # JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            JSON_COUNT=$((JSON_COUNT + 1))
            L=$(wc -l < "$file")
            TOTAL_LINES=$((TOTAL_LINES + L))
          fi
        done
        
        TOTAL_FILES=$((HTML_COUNT + JS_COUNT + CSS_COUNT + JSON_COUNT))
        
        # Criar HTML usando m√©todo SEGURO
        echo "Criando HTML..."
        
        # Criar arquivo HTML passo a passo
        cat > index.html << 'HTML_HEADER'
<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>üì• C√≥digo Fonte - Im√≥veis Macei√≥</title>
<style>
body { font-family: Arial, sans-serif; background: #0d1117; color: white; margin: 0; padding: 20px; }
.container { max-width: 1400px; margin: 0 auto; }
header { text-align: center; padding: 30px 0; border-bottom: 3px solid #2ea44f; margin-bottom: 30px; }
h1 { color: #2ea44f; font-size: 2.5em; }
h2 { color: #58a6ff; margin: 30px 0 20px; }
.file-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 15px; margin: 20px 0; }
.file-card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 20px; }
.file-card h3 { margin-top: 0; color: #58a6ff; }
.code-viewer { background: #000; padding: 20px; border-radius: 8px; margin: 20px 0; overflow-x: auto; }
pre { margin: 0; font-family: "Monaco", monospace; font-size: 0.9em; line-height: 1.4; }
.line-number { color: #6a737d; margin-right: 15px; user-select: none; }
</style>
</head>
<body>
<div class="container">
<header>
<h1>üì• C√≥digo Fonte Completo</h1>
<p>Im√≥veis Macei√≥ - Extra√ß√£o completa</p>
<p><strong>Gerado em:</strong> 
HTML_HEADER
        
        echo "$DATE_NOW" >> index.html
        
        cat >> index.html << 'HTML_HEADER2'
</p>
</header>
HTML_HEADER2
        
        # Adicionar resumo
        cat >> index.html << HTML_SUMMARY
<h2>üìä Resumo da Extra√ß√£o</h2>
<div style="background: #161b22; padding: 20px; border-radius: 8px; margin: 20px 0;">
<p><strong>Total de arquivos:</strong> $TOTAL_FILES</p>
<p><strong>Total de linhas:</strong> $TOTAL_LINES</p>
<p><strong>Fun√ß√µes JavaScript:</strong> $TOTAL_FUNCTIONS</p>
<p><strong>HTML:</strong> $HTML_COUNT arquivos</p>
<p><strong>JavaScript:</strong> $JS_COUNT arquivos</p>
<p><strong>CSS:</strong> $CSS_COUNT arquivos</p>
<p><strong>JSON:</strong> $JSON_COUNT arquivos</p>
</div>
HTML_SUMMARY
        
        # Lista de arquivos
        cat >> index.html << 'HTML_LIST_START'
<h2>üìÅ Lista de Arquivos Extra√≠dos</h2>
<div class="file-list">
HTML_LIST_START
        
        # Adicionar cada arquivo
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üìÑ $filename</h3>
<p><strong>Local:</strong> .</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> N/A (HTML)</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file")
              size=$(wc -c < "$file")
              size_kb=$((size / 1024))
              cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üé® $filename</h3>
<p><strong>Local:</strong> css</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> N/A (CSS)</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
            fi
          done
        fi
        
        # JavaScript
        # JS na raiz
        for file in fonte-completo/js/*.js; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            functions=0
            if grep -q "function" "$file"; then
              functions=$(grep -c "function" "$file")
            fi
            cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üìú $filename</h3>
<p><strong>Local:</strong> js</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> $functions</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
          fi
        done
        
        # M√≥dulos JS
        if [ -d "fonte-completo/js/modules" ]; then
          for file in fonte-completo/js/modules/*.js; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file")
              size=$(wc -c < "$file")
              size_kb=$((size / 1024))
              functions=0
              if grep -q "function" "$file"; then
                functions=$(grep -c "function" "$file")
              fi
              cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üìú $filename (M√≥dulo)</h3>
<p><strong>Local:</strong> js/modules</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> $functions</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
            fi
          done
        fi
        
        # Componentes JS
        if [ -d "fonte-completo/js/components" ]; then
          for file in fonte-completo/js/components/*.js; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file")
              size=$(wc -c < "$file")
              size_kb=$((size / 1024))
              functions=0
              if grep -q "function" "$file"; then
                functions=$(grep -c "function" "$file")
              fi
              cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üìú $filename (Componente)</h3>
<p><strong>Local:</strong> js/components</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> $functions</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
            fi
          done
        fi
        
        # JSON
        for file in fonte-completo/*.json; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            size=$(wc -c < "$file")
            size_kb=$((size / 1024))
            cat >> index.html << FILE_CARD
<div class="file-card">
<h3>üìã $filename</h3>
<p><strong>Local:</strong> .</p>
<p><strong>Linhas:</strong> $lines</p>
<p><strong>Fun√ß√µes:</strong> N/A (JSON)</p>
<p><strong>Tamanho:</strong> ${size_kb} KB</p>
</div>
FILE_CARD
          fi
        done
        
        cat >> index.html << 'HTML_LIST_END'
</div>
HTML_LIST_END
        
        # C√≥digo completo
        cat >> index.html << 'HTML_CODE_START'
<h2>üìú C√≥digo Fonte Completo</h2>
HTML_CODE_START
        
        # Adicionar c√≥digo de cada arquivo
        # HTML
        for file in fonte-completo/*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            lines=$(wc -l < "$file")
            cat >> index.html << CODE_START
<div class="code-viewer">
<h3>$filename ($lines linhas)</h3>
<pre>
CODE_START
            line_num=1
            while IFS= read -r line; do
              echo "<span class='line-number'>$line_num</span>$line<br/>" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' >> index.html
              line_num=$((line_num + 1))
            done < "$file"
            cat >> index.html << 'CODE_END'
</pre>
</div>
CODE_END
          fi
        done
        
        # CSS
        if [ -d "fonte-completo/css" ]; then
          for file in fonte-completo/css/*.css; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              lines=$(wc -l < "$file")
              cat >> index.html << CODE_START
<div class="code-viewer">
<h3>css/$filename ($lines linhas)</h3>
<pre>
CODE_START
              line_num=1
              while IFS= read -r line; do
                echo "<span class='line-number'>$line_num</span>$line<br/>" | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g' >> index.html
                line_num=$((line_num + 1))
              done < "$file"
              cat >> index.html << 'CODE_END'
</pre>
</div>
CODE_END
            fi
          done
        fi
        
        # Footer
        cat >> index.html << 'HTML_FOOTER'
<footer style="text-align: center; margin-top: 40px; padding-top: 20px; border-top: 1px solid #30363d; color: #8b949e;">
<p><strong>üì• Extra√ß√£o Completa do C√≥digo Fonte</strong></p>
<p>Todas as linhas extra√≠das sem limita√ß√µes</p>
</footer>
</div>
</body>
</html>
HTML_FOOTER
        
        echo "‚úÖ Relat√≥rio criado com sucesso!"
        echo ""
        echo "üìä ESTAT√çSTICAS:"
        echo "==============="
        echo "Arquivos: $TOTAL_FILES"
        echo "Linhas: $TOTAL_LINES"
        echo "Fun√ß√µes JS: $TOTAL_FUNCTIONS"
        echo "HTML: $HTML_COUNT"
        echo "JavaScript: $JS_COUNT"
        echo "CSS: $CSS_COUNT"
        echo "JSON: $JSON_COUNT"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy
      uses: actions/deploy-pages@v4
    
    - name: üéâ Mostrar resultado
      run: |
        echo ""
        echo "üéâ RELAT√ìRIO CRIADO COM SUCESSO!"
        echo "================================"
        echo ""
        echo "üåê ACESSE EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/"
        echo ""
        echo "‚úÖ FUNCIONALIDADES INCLU√çDAS:"
        echo "‚Ä¢ üìÅ Lista completa de arquivos"
        echo "‚Ä¢ ‚ö° Contagem de fun√ß√µes JavaScript"
        echo "‚Ä¢ üìä Estat√≠sticas precisas"
        echo "‚Ä¢ üìú C√≥digo completo sem limita√ß√µes"
        echo "‚Ä¢ üè∑Ô∏è Categoriza√ß√£o por tipo"
