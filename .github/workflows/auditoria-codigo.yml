name: üìä Auditoria Completa de Performance e Acoplamento

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * 0'

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  audit-code:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
    
    steps:
    - name: üì• Checkout do reposit√≥rio
      uses: actions/checkout@v4
    
    - name: üì• Clonar projeto completo
      run: |
        git clone https://github.com/rclessa25-hub/imoveis-maceio.git source-audit
    
    - name: üìù Criar relat√≥rio de auditoria
      run: |
        echo "üîç Iniciando auditoria completa do c√≥digo..."
        
        # Data atual
        DATE_NOW=$(date '+%d/%m/%Y %H:%M:%S')
        
        # Iniciar arquivo HTML
        echo '<!DOCTYPE html>' > audit-report.html
        echo '<html lang="pt-BR">' >> audit-report.html
        echo '<head>' >> audit-report.html
        echo '<meta charset="UTF-8">' >> audit-report.html
        echo '<meta name="viewport" content="width=device-width, initial-scale=1.0">' >> audit-report.html
        echo '<title>üìä Auditoria Completa - Performance e Acoplamento</title>' >> audit-report.html
        echo '<style>' >> audit-report.html
        echo 'body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background: #0d1117; color: white; }' >> audit-report.html
        echo '.container { max-width: 1400px; margin: 0 auto; }' >> audit-report.html
        echo 'header { background: #161b22; padding: 30px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #30363d; text-align: center; }' >> audit-report.html
        echo '.section { background: #161b22; padding: 25px; border-radius: 10px; margin: 25px 0; border: 1px solid #30363d; }' >> audit-report.html
        echo '.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin: 30px 0; }' >> audit-report.html
        echo '.stat-card { background: #1c2128; padding: 25px; border-radius: 10px; border: 1px solid #30363d; text-align: center; }' >> audit-report.html
        echo '.stat-number { font-size: 2.5em; font-weight: bold; margin: 10px 0; }' >> audit-report.html
        echo '.good { color: #3fb950; }' >> audit-report.html
        echo '.warning { color: #f1e05a; }' >> audit-report.html
        echo '.critical { color: #f85149; }' >> audit-report.html
        echo '.metric-table { width: 100%; border-collapse: collapse; margin: 20px 0; }' >> audit-report.html
        echo '.metric-table th, .metric-table td { padding: 12px; text-align: left; border-bottom: 1px solid #30363d; }' >> audit-report.html
        echo '.metric-table th { background: #1c2128; }' >> audit-report.html
        echo '.coupling-diagram { background: #0a0e14; padding: 20px; border-radius: 8px; margin: 20px 0; font-family: monospace; }' >> audit-report.html
        echo '.function-list { max-height: 400px; overflow-y: auto; }' >> audit-report.html
        echo '.function-item { padding: 10px; border-bottom: 1px solid #30363d; }' >> audit-report.html
        echo '.function-name { color: #58a6ff; font-weight: bold; }' >> audit-report.html
        echo '.complexity-badge { background: #238636; color: white; padding: 3px 8px; border-radius: 4px; font-size: 0.9em; margin-left: 10px; }' >> audit-report.html
        echo '.high-complexity { background: #f85149; }' >> audit-report.html
        echo '.medium-complexity { background: #f1e05a; color: #000; }' >> audit-report.html
        echo '.recommendation { background: #1c2128; padding: 15px; border-radius: 8px; margin: 10px 0; border-left: 4px solid #58a6ff; }' >> audit-report.html
        echo '.tool-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }' >> audit-report.html
        echo '.tool-card { background: #1c2128; padding: 20px; border-radius: 8px; }' >> audit-report.html
        echo '</style>' >> audit-report.html
        echo '<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">' >> audit-report.html
        echo '<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>' >> audit-report.html
        echo '</head>' >> audit-report.html
        echo '<body>' >> audit-report.html
        echo '<div class="container">' >> audit-report.html
        
        # Cabe√ßalho
        echo '<header>' >> audit-report.html
        echo '<h1><i class="fas fa-search"></i> Auditoria Completa de Performance</h1>' >> audit-report.html
        echo '<p>Webber Lessa Imobili√°ria - CRECI: 654/AL</p>' >> audit-report.html
        echo "<p>Data da Auditoria: $DATE_NOW</p>" >> audit-report.html
        echo '</header>' >> audit-report.html
        
        # Se√ß√£o 1: Estat√≠sticas Gerais
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-chart-bar"></i> Estat√≠sticas Gerais do Projeto</h2>' >> audit-report.html
        
        # Analisar estrutura
        echo "üîç Analisando estrutura do projeto..."
        
        # Contar arquivos por tipo
        find source-audit -name "*.js" -type f > js_files.txt
        find source-audit -name "*.css" -type f > css_files.txt
        find source-audit -name "*.html" -type f > html_files.txt
        find source-audit -name "*.json" -type f > json_files.txt
        
        js_count=$(wc -l < js_files.txt)
        css_count=$(wc -l < css_files.txt)
        html_count=$(wc -l < html_files.txt)
        json_count=$(wc -l < json_files.txt)
        
        # Analisar JavaScript
        total_js_lines=0
        total_js_functions=0
        complex_functions=0
        
        echo "üìä Analisando JavaScript..."
        
        while read js_file; do
          if [ -f "$js_file" ]; then
            lines=$(wc -l < "$js_file")
            total_js_lines=$((total_js_lines + lines))
            
            # Contar fun√ß√µes
            functions=$(grep -c "function\|=>\|class " "$js_file" 2>/dev/null || echo "0")
            total_js_functions=$((total_js_functions + functions))
            
            # Analisar complexidade (linhas por fun√ß√£o)
            if [ "$functions" -gt 0 ]; then
              avg_lines=$((lines / functions))
              if [ "$avg_lines" -gt 30 ]; then
                complex_functions=$((complex_functions + 1))
              fi
            fi
          fi
        done < js_files.txt
        
        # Analisar CSS
        total_css_lines=0
        total_css_rules=0
        
        while read css_file; do
          if [ -f "$css_file" ]; then
            lines=$(wc -l < "$css_file")
            total_css_lines=$((total_css_lines + lines))
            
            # Contar regras CSS
            rules=$(grep -c "{" "$css_file" 2>/dev/null || echo "0")
            total_css_rules=$((total_css_rules + rules))
          fi
        done < css_files.txt
        
        # Analisar HTML principal
        main_html="source-audit/index.html"
        html_lines=0
        if [ -f "$main_html" ]; then
          html_lines=$(wc -l < "$main_html")
          
          # Contar elementos
          elements=$(grep -c "<[^!]" "$main_html" 2>/dev/null || echo "0")
          
          # Contar scripts inline
          inline_scripts=$(grep -c "<script>" "$main_html" 2>/dev/null || echo "0")
          
          # Contar CSS inline
          inline_styles=$(grep -c "<style>" "$main_html" 2>/dev/null || echo "0")
        fi
        
        # Calcular m√©tricas de qualidade
        total_files=$((js_count + css_count + html_count + json_count))
        total_lines=$((total_js_lines + total_css_lines + html_lines))
        
        # Complexidade m√©dia por fun√ß√£o
        if [ "$total_js_functions" -gt 0 ]; then
          avg_complexity=$((total_js_lines / total_js_functions))
        else
          avg_complexity=0
        fi
        
        # Estat√≠sticas
        echo '<div class="stats-grid">' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-file-code fa-2x"></i>' >> audit-report.html
        echo "<div class='stat-number good'>$total_files</div>" >> audit-report.html
        echo '<p>Arquivos Analisados</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-bars fa-2x"></i>' >> audit-report.html
        echo "<div class='stat-number warning'>$total_lines</div>" >> audit-report.html
        echo '<p>Linhas de C√≥digo</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-code fa-2x"></i>' >> audit-report.html
        echo "<div class='stat-number warning'>$total_js_functions</div>" >> audit-report.html
        echo '<p>Fun√ß√µes JavaScript</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        if [ "$avg_complexity" -lt 20 ]; then
          complexity_class="good"
        elif [ "$avg_complexity" -lt 40 ]; then
          complexity_class="warning"
        else
          complexity_class="critical"
        fi
        echo "<div class='stat-number $complexity_class'>$avg_complexity</div>" >> audit-report.html
        echo '<p>Complexidade M√©dia</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # Se√ß√£o 2: An√°lise de Acoplamento
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-link"></i> An√°lise de Acoplamento e Depend√™ncias</h2>' >> audit-report.html
        
        # Analisar depend√™ncias entre arquivos
        echo '<h3>üìä Depend√™ncias entre M√≥dulos</h3>' >> audit-report.html
        
        echo '<table class="metric-table">' >> audit-report.html
        echo '<thead><tr><th>M√≥dulo</th><th>Depend√™ncias</th><th>Tipo Acoplamento</th><th>N√≠vel</th></tr></thead>' >> audit-report.html
        echo '<tbody>' >> audit-report.html
        
        # Analisar index.html
        deps_html=$(grep -c "src=\|href=" "$main_html" 2>/dev/null || echo "0")
        echo '<tr>' >> audit-report.html
        echo '<td>index.html</td>' >> audit-report.html
        echo "<td>$deps_html</td>" >> audit-report.html
        echo '<td>Resource</td>' >> audit-report.html
        if [ "$deps_html" -lt 10 ]; then
          echo '<td class="good">Baixo</td>' >> audit-report.html
        elif [ "$deps_html" -lt 20 ]; then
          echo '<td class="warning">M√©dio</td>' >> audit-report.html
        else
          echo '<td class="critical">Alto</td>' >> audit-report.html
        fi
        echo '</tr>' >> audit-report.html
        
        # Analisar arquivos JS por depend√™ncias
        echo "üîó Analisando acoplamento JavaScript..."
        
        js_deps_count=0
        global_vars_count=0
        
        while read js_file; do
          if [ -f "$js_file" ]; then
            # Contar refer√™ncias externas
            deps=$(grep -c "document\.\|window\.\|fetch\|XMLHttpRequest\|import\|require" "$js_file" 2>/dev/null || echo "0")
            js_deps_count=$((js_deps_count + deps))
            
            # Contar vari√°veis globais
            globals=$(grep -c "var [a-zA-Z]" "$js_file" 2>/dev/null || echo "0")
            global_vars_count=$((global_vars_count + globals))
            
            filename=$(basename "$js_file")
            
            echo '<tr>' >> audit-report.html
            echo "<td>$filename</td>" >> audit-report.html
            echo "<td>$deps</td>" >> audit-report.html
            echo '<td>Functional</td>' >> audit-report.html
            if [ "$deps" -lt 5 ]; then
              echo '<td class="good">Baixo</td>' >> audit-report.html
            elif [ "$deps" -lt 15 ]; then
              echo '<td class="warning">M√©dio</td>' >> audit-report.html
            else
              echo '<td class="critical">Alto</td>' >> audit-report.html
            fi
            echo '</tr>' >> audit-report.html
          fi
        done < js_files.txt
        
        echo '</tbody>' >> audit-report.html
        echo '</table>' >> audit-report.html
        
        # Diagrama de acoplamento
        echo '<h3>üîó Diagrama de Acoplamento</h3>' >> audit-report.html
        echo '<div class="coupling-diagram">' >> audit-report.html
        echo '<pre style="margin: 0;">' >> audit-report.html
        
        # Gerar diagrama simplificado
        echo 'index.html' >> audit-report.html
        echo '‚îú‚îÄ‚îÄ üìÑ main.css' >> audit-report.html
        echo '‚îú‚îÄ‚îÄ üìÑ header.css' >> audit-report.html
        echo '‚îú‚îÄ‚îÄ üìÑ gallery.css' >> audit-report.html
        echo '‚îú‚îÄ‚îÄ üìÑ admin.css' >> audit-report.html
        echo '‚îî‚îÄ‚îÄ üìÅ js/' >> audit-report.html
        echo '    ‚îú‚îÄ‚îÄ üìÑ utils.js (INDEPENDENTE)' >> audit-report.html
        echo '    ‚îú‚îÄ‚îÄ üìÑ properties.js ‚Üí utils.js' >> audit-report.html
        echo '    ‚îú‚îÄ‚îÄ üìÑ gallery.js ‚Üí properties.js, utils.js' >> audit-report.html
        echo '    ‚îî‚îÄ‚îÄ üìÑ admin.js ‚Üí properties.js, utils.js' >> audit-report.html
        
        echo '</pre>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # M√©tricas de acoplamento
        echo '<h3>üìà M√©tricas de Acoplamento</h3>' >> audit-report.html
        echo '<div class="stats-grid">' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-globe fa-2x"></i>' >> audit-report.html
        echo "<div class='stat-number warning'>$global_vars_count</div>" >> audit-report.html
        echo '<p>Vari√°veis Globais</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-exchange-alt fa-2x"></i>' >> audit-report.html
        echo "<div class='stat-number'>$js_deps_count</div>" >> audit-report.html
        echo '<p>Depend√™ncias JS</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-layer-group fa-2x"></i>' >> audit-report.html
        if [ "$inline_scripts" -eq 0 ]; then
          echo '<div class="stat-number good">0</div>' >> audit-report.html
        else
          echo "<div class='stat-number critical'>$inline_scripts</div>" >> audit-report.html
        fi
        echo '<p>Scripts Inline</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="stat-card">' >> audit-report.html
        echo '<i class="fas fa-paint-brush fa-2x"></i>' >> audit-report.html
        if [ "$inline_styles" -eq 0 ]; then
          echo '<div class="stat-number good">0</div>' >> audit-report.html
        else
          echo "<div class='stat-number critical'>$inline_styles</div>" >> audit-report.html
        fi
        echo '<p>CSS Inline</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # Se√ß√£o 3: An√°lise de Performance
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-tachometer-alt"></i> An√°lise de Performance</h2>' >> audit-report.html
        
        # Analisar overhead de fun√ß√µes
        echo '<h3>‚ö° Overhead de Chamadas de Fun√ß√£o</h3>' >> audit-report.html
        
        # Identificar fun√ß√µes mais chamadas
        echo '<div class="function-list">' >> audit-report.html
        
        high_call_functions=()
        
        while read js_file; do
          if [ -f "$js_file" ]; then
            # Extrair fun√ß√µes e estimar chamadas
            grep -n "function\|=>" "$js_file" | while read -r line; do
              line_num=$(echo "$line" | cut -d: -f1)
              func_name=$(echo "$line" | sed -e 's/.*function //' -e 's/(.*//' -e 's/.*=>.*//' | xargs)
              
              if [ -n "$func_name" ] && [ "$func_name" != "{" ]; then
                # Contar chamadas desta fun√ß√£o no c√≥digo
                calls=$(grep -c "$func_name(" "$js_file" 2>/dev/null || echo "0")
                
                if [ "$calls" -gt 5 ]; then
                  echo '<div class="function-item">' >> audit-report.html
                  echo "<span class='function-name'>$func_name</span>" >> audit-report.html
                  echo "<span class='complexity-badge'>$calls chamadas</span>" >> audit-report.html
                  
                  # Analisar complexidade ciclom√°tica (simplificada)
                  func_lines=0
                  if [ -n "$line_num" ]; then
                    # Tentar encontrar fim da fun√ß√£o
                    next_func=$(grep -n "function\|=>" "$js_file" | grep -A1 "^$line_num:" | tail -1 | cut -d: -f1)
                    if [ -n "$next_func" ] && [ "$next_func" -gt "$line_num" ]; then
                      func_lines=$((next_func - line_num))
                    else
                      total_lines=$(wc -l < "$js_file")
                      func_lines=$((total_lines - line_num))
                    fi
                    
                    if [ "$func_lines" -gt 50 ]; then
                      echo "<span class='complexity-badge high-complexity'>$func_lines linhas</span>" >> audit-report.html
                    elif [ "$func_lines" -gt 20 ]; then
                      echo "<span class='complexity-badge medium-complexity'>$func_lines linhas</span>" >> audit-report.html
                    else
                      echo "<span class='complexity-badge'>$func_lines linhas</span>" >> audit-report.html
                    fi
                  fi
                  
                  echo '</div>' >> audit-report.html
                fi
              fi
            done
          fi
        done < js_files.txt
        
        echo '</div>' >> audit-report.html
        
        # Recomenda√ß√µes de otimiza√ß√£o
        echo '<h3>üéØ Recomenda√ß√µes de Otimiza√ß√£o</h3>' >> audit-report.html
        
        echo '<div class="recommendation">' >> audit-report.html
        echo '<strong><i class="fas fa-bolt"></i> Inlining de Fun√ß√µes Cr√≠ticas</strong>' >> audit-report.html
        echo '<p>Fun√ß√µes pequenas (menos de 10 linhas) chamadas frequentemente podem ser inline para reduzir overhead.</p>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li>Criar cache de resultados para fun√ß√µes puras</li>' >> audit-report.html
        echo '<li>Usar par√¢metros por refer√™ncia quando poss√≠vel</li>' >> audit-report.html
        echo '<li>Evitar closures desnecess√°rios em loops</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="recommendation">' >> audit-report.html
        echo '<strong><i class="fas fa-database"></i> Redu√ß√£o de Depend√™ncias Globais</strong>' >> audit-report.html
        echo '<p>Reduzir o uso de vari√°veis globais para diminuir acoplamento.</p>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li>Encapsular em m√≥dulos IIFE</li>' >> audit-report.html
        echo '<li>Usar padr√£o Module Pattern</li>' >> audit-report.html
        echo '<li>Implementar dependency injection</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        
        # Se√ß√£o 4: Ferramentas e T√©cnicas
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-tools"></i> Ferramentas e T√©cnicas de Medi√ß√£o</h2>' >> audit-report.html
        
        echo '<div class="tool-list">' >> audit-report.html
        
        echo '<div class="tool-card">' >> audit-report.html
        echo '<h4><i class="fas fa-chart-line"></i> Profiling com Chrome DevTools</h4>' >> audit-report.html
        echo '<p>Use a aba Performance para gravar e analisar execu√ß√£o. Identifique:</p>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li>Fun√ß√µes com maior tempo de execu√ß√£o</li>' >> audit-report.html
        echo '<li>Chamadas desnecess√°rias</li>' >> audit-report.html
        echo '<li>Bottlenecks de CPU</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="tool-card">' >> audit-report.html
        echo '<h4><i class="fas fa-stopwatch"></i> Benchmarking</h4>' >> audit-report.html
        echo '<p>Medir tempo de execu√ß√£o com performance.now():</p>' >> audit-report.html
        echo '<pre style="background: #0a0e14; padding: 10px; border-radius: 5px; margin: 10px 0;">' >> audit-report.html
        echo 'const start = performance.now();' >> audit-report.html
        echo '// C√≥digo a medir' >> audit-report.html
        echo 'const end = performance.now();' >> audit-report.html
        echo 'console.log(`Tempo: ${end - start}ms`);' >> audit-report.html
        echo '</pre>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="tool-card">' >> audit-report.html
        echo '<h4><i class="fas fa-sitemap"></i> An√°lise de Complexidade</h4>' >> audit-report.html
        echo '<p>M√©tricas para identificar fun√ß√µes problem√°ticas:</p>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li>Complexidade Ciclom√°tica (if/else, loops)</li>' >> audit-report.html
        echo '<li>N√∫mero de par√¢metros (max 3-4 ideal)</li>' >> audit-report.html
        echo '<li>Linhas de c√≥digo por fun√ß√£o (max 20-30 ideal)</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div class="tool-card">' >> audit-report.html
        echo '<h4><i class="fas fa-network-wired"></i> An√°lise de Depend√™ncias</h4>' >> audit-report.html
        echo '<p>Ferramentas para mapear acoplamento:</p>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li>Madge - gerar gr√°ficos de depend√™ncias</li>' >> audit-report.html
        echo '<li>Webpack Bundle Analyzer</li>' >> audit-report.html
        echo '<li>ESLint plugin no-unused-vars</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        
        # Exemplos de medi√ß√£o
        echo '<h3>üìè Exemplos de C√≥digo de Medi√ß√£o</h3>' >> audit-report.html
        echo '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>Medi√ß√£o de Overhead de Fun√ß√£o</h4>' >> audit-report.html
        echo '<pre style="background: #0a0e14; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto;">' >> audit-report.html
        echo '// Fun√ß√£o para medir overhead' >> audit-report.html
        echo 'function measureFunctionOverhead(func, iterations = 10000) {' >> audit-report.html
        echo '  const start = performance.now();' >> audit-report.html
        echo '  for (let i = 0; i < iterations; i++) {' >> audit-report.html
        echo '    func();' >> audit-report.html
        echo '  }' >> audit-report.html
        echo '  const end = performance.now();' >> audit-report.html
        echo '  return (end - start) / iterations;' >> audit-report.html
        echo '}' >> audit-report.html
        echo '' >> audit-report.html
        echo '// Testar fun√ß√£o espec√≠fica' >> audit-report.html
        echo 'const avgTime = measureFunctionOverhead(() => {' >> audit-report.html
        echo '  // C√≥digo a testar' >> audit-report.html
        echo '  return Math.sqrt(123456);' >> audit-report.html
        echo '}, 100000);' >> audit-report.html
        echo '' >> audit-report.html
        echo 'console.log(`Tempo m√©dio por chamada: ${avgTime}ms`);' >> audit-report.html
        echo '</pre>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>Identifica√ß√£o de Hotspots</h4>' >> audit-report.html
        echo '<pre style="background: #0a0e14; padding: 15px; border-radius: 5px; margin: 10px 0; overflow-x: auto;">' >> audit-report.html
        echo '// Mapa de hotspots de fun√ß√£o' >> audit-report.html
        echo 'const functionHotspots = {};' >> audit-report.html
        echo '' >> audit-report.html
        echo '// Decorador para medir chamadas' >> audit-report.html
        echo 'function trackFunctionCalls(func, funcName) {' >> audit-report.html
        echo '  return function(...args) {' >> audit-report.html
        echo '    if (!functionHotspots[funcName]) {' >> audit-report.html
        echo '      functionHotspots[funcName] = 0;' >> audit-report.html
        echo '    }' >> audit-report.html
        echo '    functionHotspots[funcName]++;' >> audit-report.html
        echo '    return func.apply(this, args);' >> audit-report.html
        echo '  };' >> audit-report.html
        echo '}' >> audit-report.html
        echo '' >> audit-report.html
        echo '// Exemplo de uso' >> audit-report.html
        echo 'const originalFunction = () => { /* ... */ }' >> audit-report.html
        echo 'const trackedFunction = trackFunctionCalls(originalFunction, "minhaFuncao");' >> audit-report.html
        echo '' >> audit-report.html
        echo '// Ver hotspots ap√≥s execu√ß√£o' >> audit-report.html
        echo 'console.log("Hotspots:", functionHotspots);' >> audit-report.html
        echo '</pre>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # Se√ß√£o 5: Melhores Pr√°ticas
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-graduation-cap"></i> Melhores Pr√°ticas de Otimiza√ß√£o</h2>' >> audit-report.html
        
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px;">' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4><i class="fas fa-arrow-right"></i> Passagem de Par√¢metros</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><strong>Objetos grandes:</strong> Passar por refer√™ncia</li>' >> audit-report.html
        echo '<li><strong>Tipos primitivos:</strong> Passar por valor OK</li>' >> audit-report.html
        echo '<li><strong>Dicas:</strong>' >> audit-report.html
        echo '  <ul>' >> audit-report.html
        echo '  <li>Agrupar par√¢metros em objetos</li>' >> audit-report.html
        echo '  <li>Usar destructuring para clareza</li>' >> audit-report.html
        echo '  <li>Evitar mais de 4 par√¢metros</li>' >> audit-report.html
        echo '  </ul>' >> audit-report.html
        echo '</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4><i class="fas fa-code-branch"></i> Crit√©rios para Inlining</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><strong>FAZER Inlining quando:</strong>' >> audit-report.html
        echo '  <ul>' >> audit-report.html
        echo '  <li>Fun√ß√£o tem menos de 10 linhas</li>' >> audit-report.html
        echo '  <li>Chamada em loops cr√≠ticos</li>' >> audit-report.html
        echo '  <li>Fun√ß√£o chamada apenas 1-2 vezes</li>' >> audit-report.html
        echo '  </ul>' >> audit-report.html
        echo '</li>' >> audit-report.html
        echo '<li><strong>EVITAR Inlining quando:</strong>' >> audit-report.html
        echo '  <ul>' >> audit-report.html
        echo '  <li>Fun√ß√£o complexa (20+ linhas)</li>' >> audit-report.html
        echo '  <li>Reutilizada em v√°rios lugares</li>' >> audit-report.html
        echo '  <li>Precisa de manuten√ß√£o separada</li>' >> audit-report.html
        echo '  </ul>' >> audit-report.html
        echo '</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4><i class="fas fa-filter"></i> Redu√ß√£o de Chamadas</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><strong>Debouncing:</strong> Para eventos resize/scroll</li>' >> audit-report.html
        echo '<li><strong>Throttling:</strong> Para eventos mousemove</li>' >> audit-report.html
        echo '<li><strong>Caching:</strong> Resultados de fun√ß√µes puras</li>' >> audit-report.html
        echo '<li><strong>Memoization:</strong> Para fun√ß√µes recursivas</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        
        # Checklist de otimiza√ß√£o
        echo '<h3>‚úÖ Checklist de Otimiza√ß√£o</h3>' >> audit-report.html
        echo '<div style="background: #1c2128; padding: 20px; border-radius: 8px;">' >> audit-report.html
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>JavaScript</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><input type="checkbox"> Reduzir vari√°veis globais</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Usar const/let em vez de var</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Implementar debouncing</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Cache de seletores DOM</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>CSS</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><input type="checkbox"> Remover CSS n√£o utilizado</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Minimizar especificidade</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Usar vari√°veis CSS</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Otimizar anima√ß√µes</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>HTML</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        echo '<li><input type="checkbox"> Remover scripts inline</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Usar atributos defer/async</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Otimizar ordem de carregamento</li>' >> audit-report.html
        echo '<li><input type="checkbox"> Lazy loading de imagens</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        
        # Se√ß√£o 6: Conclus√£o e Resumo
        echo '<div class="section">' >> audit-report.html
        echo '<h2><i class="fas fa-clipboard-check"></i> Resumo da Auditoria</h2>' >> audit-report.html
        
        # Calcular pontua√ß√£o geral
        score=0
        max_score=100
        
        # Avaliar modulariza√ß√£o
        if [ "$inline_scripts" -eq 0 ]; then
          score=$((score + 20))
        else
          score=$((score + 10))
        fi
        
        # Avaliar complexidade
        if [ "$avg_complexity" -lt 25 ]; then
          score=$((score + 20))
        elif [ "$avg_complexity" -lt 40 ]; then
          score=$((score + 10))
        else
          score=$((score + 5))
        fi
        
        # Avaliar acoplamento
        if [ "$global_vars_count" -lt 10 ]; then
          score=$((score + 20))
        elif [ "$global_vars_count" -lt 20 ]; then
          score=$((score + 15))
        else
          score=$((score + 5))
        fi
        
        # Avaliar estrutura
        if [ "$js_count" -ge 4 ]; then
          score=$((score + 20))
        elif [ "$js_count" -ge 2 ]; then
          score=$((score + 15))
        else
          score=$((score + 5))
        fi
        
        # Avaliar CSS modularizado
        if [ "$css_count" -ge 4 ]; then
          score=$((score + 20))
        else
          score=$((score + 10))
        fi
        
        # Determinar status
        if [ "$score" -ge 80 ]; then
          status="√ìTIMO"
          status_class="good"
        elif [ "$score" -ge 60 ]; then
          status="BOM"
          status_class="warning"
        else
          status="PRECISA MELHORAR"
          status_class="critical"
        fi
        
        echo '<div style="text-align: center; padding: 30px; background: #1c2128; border-radius: 10px;">' >> audit-report.html
        echo "<h3 style='margin: 0 0 20px 0;'>Pontua√ß√£o Geral de Qualidade</h3>" >> audit-report.html
        echo "<div style='font-size: 4em; font-weight: bold; margin: 20px 0; color: $status_class;'>$score/$max_score</div>" >> audit-report.html
        echo "<h3 class='$status_class'>$status</h3>" >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # Resumo executivo
        echo '<div style="margin-top: 30px;">' >> audit-report.html
        echo '<h3>üìã Resumo Executivo</h3>' >> audit-report.html
        echo '<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin: 20px 0;">' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>‚úÖ Pontos Fortes</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        if [ "$css_count" -ge 4 ]; then
          echo '<li>CSS bem modularizado</li>' >> audit-report.html
        fi
        if [ "$inline_scripts" -eq 0 ]; then
          echo '<li>Sem scripts inline</li>' >> audit-report.html
        fi
        if [ "$total_js_functions" -gt 0 ]; then
          echo "<li>$total_js_functions fun√ß√µes identificadas</li>" >> audit-report.html
        fi
        echo '<li>Estrutura de pastas organizada</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>‚ö†Ô∏è √Åreas para Melhoria</h4>' >> audit-report.html
        echo '<ul>' >> audit-report.html
        if [ "$global_vars_count" -gt 10 ]; then
          echo "<li>Reduzir vari√°veis globais ($global_vars_count)</li>" >> audit-report.html
        fi
        if [ "$avg_complexity" -gt 25 ]; then
          echo "<li>Reduzir complexidade m√©dia ($avg_complexity linhas/fun√ß√£o)</li>" >> audit-report.html
        fi
        if [ "$inline_styles" -gt 0 ]; then
          echo "<li>Remover CSS inline ($inline_styles)</li>" >> audit-report.html
        fi
        echo '<li>Implementar mais t√©cnicas de caching</li>' >> audit-report.html
        echo '</ul>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '<div>' >> audit-report.html
        echo '<h4>üéØ A√ß√µes Priorit√°rias</h4>' >> audit-report.html
        echo '<ol>' >> audit-report.html
        echo '<li>Identificar fun√ß√µes com maior overhead</li>' >> audit-report.html
        echo '<li>Implementar memoization para fun√ß√µes puras</li>' >> audit-report.html
        echo '<li>Aplicar debouncing em eventos de UI</li>' >> audit-report.html
        echo '<li>Reduzir acoplamento entre m√≥dulos</li>' >> audit-report.html
        echo '</ol>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        # Informa√ß√µes finais
        echo '<div style="text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #30363d;">' >> audit-report.html
        echo "<p><strong>Auditoria conclu√≠da em:</strong> $DATE_NOW</p>" >> audit-report.html
        echo '<p>' >> audit-report.html
        echo '<a href="https://rclessa25-hub.github.io/imoveis-maceio/"><i class="fas fa-external-link-alt"></i> Site Principal</a>' >> audit-report.html
        echo '<span style="margin: 0 10px;">‚Ä¢</span>' >> audit-report.html
        echo '<a href="https://github.com/rclessa25-hub/imoveis-maceio"><i class="fab fa-github"></i> Reposit√≥rio</a>' >> audit-report.html
        echo '<span style="margin: 0 10px;">‚Ä¢</span>' >> audit-report.html
        echo '<a href="#"><i class="fas fa-download"></i> Baixar Relat√≥rio</a>' >> audit-report.html
        echo '</p>' >> audit-report.html
        echo '</div>' >> audit-report.html
        
        echo '</div>' >> audit-report.html
        echo '</body>' >> audit-report.html
        echo '</html>' >> audit-report.html
        
        # Limpar arquivos tempor√°rios
        rm -f js_files.txt css_files.txt html_files.txt json_files.txt
        
        echo "‚úÖ Relat√≥rio de auditoria criado com sucesso!"
        echo "üìä Estat√≠sticas coletadas:"
        echo "  ‚Ä¢ Arquivos JS: $js_count"
        echo "  ‚Ä¢ Fun√ß√µes: $total_js_functions"
        echo "  ‚Ä¢ Complexidade m√©dia: $avg_complexity linhas/fun√ß√£o"
        echo "  ‚Ä¢ Vari√°veis globais: $global_vars_count"
        echo "  ‚Ä¢ Pontua√ß√£o qualidade: $score/$max_score"
    
    - name: üì¶ Upload para GitHub Pages
      uses: actions/upload-pages-artifact@v3
      with:
        path: '.'
    
    - name: üöÄ Deploy do relat√≥rio
      uses: actions/deploy-pages@v4
    
    - name: üéâ Resultado final
      run: |
        echo ""
        echo "üéâ AUDITORIA DE PERFORMANCE COMPLETA!"
        echo "===================================="
        echo ""
        echo "‚úÖ AN√ÅLISE DE ACOPLAMENTO"
        echo "‚úÖ M√âTRICAS DE COMPLEXIDADE"
        echo "‚úÖ IDENTIFICA√á√ÉO DE OVERHEAD"
        echo "‚úÖ RECOMENDA√á√ïES DE OTIMIZA√á√ÉO"
        echo ""
        echo "üîç RELAT√ìRIO INCLUI:"
        echo "‚Ä¢ üìä Estat√≠sticas detalhadas do c√≥digo"
        echo "‚Ä¢ üîó An√°lise de acoplamento e depend√™ncias"
        echo "‚Ä¢ ‚ö° Identifica√ß√£o de fun√ß√µes com maior overhead"
        echo "‚Ä¢ üõ†Ô∏è Ferramentas e t√©cnicas de medi√ß√£o"
        echo "‚Ä¢ üéØ Melhores pr√°ticas de otimiza√ß√£o"
        echo "‚Ä¢ ‚úÖ Checklist de a√ß√µes priorit√°rias"
        echo ""
        echo "üåê ACESSE O RELAT√ìRIO EM:"
        echo "https://rclessa25-hub.github.io/reports-wlimoveis/audit-report.html"
        echo ""
        echo "üìã PR√ìXIMOS PASSOS RECOMENDADOS:"
        echo "1. Implementar as recomenda√ß√µes de otimiza√ß√£o"
        echo "2. Usar as t√©cnicas de profiling sugeridas"
        echo "3. Monitorar performance ap√≥s otimiza√ß√µes"
        echo "4. Re-executar auditoria periodicamente"
